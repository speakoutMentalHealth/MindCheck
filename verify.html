<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SpeakOut MindCheck ‚Äî Verify Certificate</title>
  <link rel="icon" href="favicon.png"/>
  <link rel="stylesheet" href="mc-theme.css"/>
  <meta name="theme-color" content="#22c55e"/>

  <style>
    main { max-width:780px; margin:0 auto; padding:16px; text-align:left; }
    .muted { color:#64748b; }
    .status-ok { color:#166534; font-weight:700; }
    .status-bad { color:#b91c1c; font-weight:700; }
    .status-warn { color:#854d0e; font-weight:600; }
    .pill { border-radius:999px; border:1px solid #e5e7eb; padding:4px 10px; background:#f9fafb; font-size:.85rem; }
    .field-label { font-weight:700; margin:8px 0 4px; display:block; }
    .input-like { width:100%; padding:10px 12px; border-radius:12px; border:1px solid #d1d5db; font-size:1rem; }
    .input-like:focus { outline:none; border-color:#22c55e; box-shadow:0 0 0 1px #22c55e33; }
    .result-box { margin-top:12px; padding:12px; border-radius:12px; border:1px solid #e5e7eb; background:#ffffff; }
    .small-meta { font-size:.88rem; color:#4b5563; }
  </style>

  <!-- Plausible -->
  <script defer data-domain="speakoutmentalhealth.github.io" src="https://plausible.io/js/script.js"></script>
  <script>
    (function(){
      try { window.plausible && window.plausible('VerifyViewed'); } catch(e){}
    })();
  </script>
</head>
<body>
  <header>üß† SpeakOut MindCheck Nigeria</header>

  <main>
    <h2>Verify Volunteer Training Certificate</h2>
    <p class="muted">
      Enter the <b>Certificate ID</b> exactly as it appears on the document
      (for example: <code>MC-CERT-20251113-ABC123</code>). We‚Äôll check if it
      matches our official records.
    </p>

    <div class="card" style="margin-top:12px;">
      <label for="certIdInput" class="field-label">Certificate ID</label>
      <input id="certIdInput" class="input-like" placeholder="MC-CERT-YYYYMMDD-XXXXXX"/>

      <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
        <span id="formatStatus" class="muted">Waiting for ID‚Ä¶</span>
        <span class="pill">Format: MC-CERT-YYYYMMDD-XXXXXX</span>
      </div>

      <div class="toolbar" style="margin-top:12px;">
        <button id="checkBtn" class="btn btn-primary" type="button">Check Certificate</button>
        <a class="btn btn-ghost" href="training-hub.html">‚Üê Back to Training Hub</a>
        <a class="btn btn-ghost" href="index.html">Home</a>
      </div>

      <div id="verifyResult" class="result-box" style="display:none;"></div>
    </div>

    <p class="muted" style="margin-top:14px;font-size:.9rem;">
      Data is checked securely against SpeakOut MindCheck records. For questions about
      data protection or manual verification, email
      <a href="mailto:speaaakout@gmail.com">speaaakout@gmail.com</a>.
    </p>
  </main>

  <footer style="margin-top:16px;">
    üîí <a href="privacy.html">Privacy</a> ‚Ä¢
    üìÑ <a href="terms.html">Terms</a> ‚Ä¢
    üè• <a href="resources.html">Clinics & Resources</a> ‚Ä¢
    ‚úâÔ∏è <a href="mailto:speaaakout@gmail.com">speaaakout@gmail.com</a>
  </footer>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbwbTvjd_4QXeFUmtBZxK1aldG0CtGSEELiP-koRFO-0G-IqctT32syjnSF1-Crl5tQ00A/exec?auth=speakout123';

    const certInput   = document.getElementById('certIdInput');
    const checkBtn    = document.getElementById('checkBtn');
    const formatLabel = document.getElementById('formatStatus');
    const resultBox   = document.getElementById('verifyResult');

    // Simple front-end pattern check: MC-CERT-YYYYMMDD-XXXXXX
    const CERT_PATTERN = /^MC-CERT-\d{8}-[A-Z0-9]{6}$/;

    function updateFormatStatus() {
      const raw = (certInput.value || '').trim().toUpperCase();
      if (!raw) {
        formatLabel.textContent = 'Waiting for ID‚Ä¶';
        formatLabel.className = 'muted';
        return;
      }
      if (CERT_PATTERN.test(raw)) {
        formatLabel.textContent = 'Format OK ‚Äî you can check this ID.';
        formatLabel.className = 'status-ok';
      } else {
        formatLabel.textContent = 'Format does not look correct.';
        formatLabel.className = 'status-bad';
      }
    }

    certInput.addEventListener('input', () => {
      certInput.value = certInput.value.toUpperCase();
      updateFormatStatus();
    });

    async function verifyCertificate() {
      const certId = (certInput.value || '').trim().toUpperCase();
      resultBox.style.display = 'block';

      if (!certId) {
        resultBox.innerHTML = '<p class="status-bad">Please enter a Certificate ID.</p>';
        return;
      }

      // Front-end format check
      if (!CERT_PATTERN.test(certId)) {
        resultBox.innerHTML = '<p class="status-bad">‚ùå The ID format is not recognised. Please check and try again.</p>';
        return;
      }

      resultBox.innerHTML = '<p class="status-warn">Checking certificate with SpeakOut MindCheck records‚Ä¶</p>';

      // Plausible event (attempt)
      try { window.plausible && window.plausible('VerifyAttempt', { props: { certIdPrefix: certId.slice(0, 12) }}); } catch(e){}

      try {
        const payload = {
          type: 'verify_cert',
          cert_id: certId,
          app_version: 'v1.0.0'
        };

        const resp = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' }, // no CORS preflight
          body: JSON.stringify(payload)
        });

        const text = await resp.text();
        let data;
        try { data = JSON.parse(text); } catch(e) { data = null; }

        if (!resp.ok || !data) {
          resultBox.innerHTML = `
            <p class="status-bad">‚ùå We could not contact the verification service right now.</p>
            <p class="small-meta">If this persists, please email <a href="mailto:speaaakout@gmail.com">speaaakout@gmail.com</a> with the Certificate ID.</p>
          `;
          return;
        }

        // Expected shape from backend (you can match this in Apps Script):
        // { ok:true, valid:true/false, cert:{ name, score, date_iso, uid } }
        if (data.valid && data.cert) {
          const c = data.cert;
          const name  = c.name  || 'Volunteer';
          const score = c.score || '‚Äî';
          const date  = c.date_iso ? new Date(c.date_iso).toLocaleDateString() : '‚Äî';

          resultBox.innerHTML = `
            <p class="status-ok">‚úÖ Valid certificate issued by SpeakOut MindCheck.</p>
            <p class="small-meta">
              <b>Name:</b> ${name}<br/>
              <b>Score:</b> ${score}%<br/>
              <b>Date issued:</b> ${date}<br/>
              <b>Certificate ID:</b> <code>${certId}</code>
            </p>
          `;

          try { window.plausible && window.plausible('VerifySuccess'); } catch(e){}
        } else {
          resultBox.innerHTML = `
            <p class="status-bad">‚ùå Certificate ID not recognised in SpeakOut MindCheck records.</p>
            <p class="small-meta">
              Please confirm the ID on the certificate. If you believe this is an error,
              contact <a href="mailto:speaaakout@gmail.com">speaaakout@gmail.com</a> with a copy of the document.
            </p>
          `;
          try { window.plausible && window.plausible('VerifyNotRecognised'); } catch(e){}
        }
      } catch (err) {
        console.warn('Verify error:', err);
        resultBox.innerHTML = `
          <p class="status-bad">‚ùå A network or server error occurred while verifying.</p>
          <p class="small-meta">
            Please try again later or email <a href="mailto:speaaakout@gmail.com">speaaakout@gmail.com</a>.
          </p>
        `;
      }
    }

    checkBtn.addEventListener('click', verifyCertificate);

    // Submit on Enter
    certInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') verifyCertificate();
    });

    // If ?certId= is present, auto-fill and check
    (function prefillFromQuery(){
      const params = new URLSearchParams(location.search);
      const id = params.get('certId');
      if (id) {
        certInput.value = id.toUpperCase();
        updateFormatStatus();
        // small delay so UI draws before fetch
        setTimeout(verifyCertificate, 150);
      } else {
        updateFormatStatus();
      }
    })();
  </script>
</body>
</html>

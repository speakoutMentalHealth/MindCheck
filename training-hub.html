<script>
  // ---------- CONFIG ----------
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwbTvjd_4QXeFUmtBZxK1aldG0CtGSEELiP-koRFO-0G-IqctT32syjnSF1-Crl5tQ00A/exec';

  const KEY_POINTS           = 'mc_points';
  const KEY_BADGES           = 'mc_badges';
  const KEY_TRAINING         = 'mc_training';
  const KEY_TRAINING_LOG     = 'mc_training_log';
  const KEY_TIMER_START      = 'mc_training_timer_start';
  const KEY_LESSON_PROGRESS  = 'mc_training_lessons_done';
  const KEY_TRAINING_ATTEMPTS= 'mc_training_attempts';   // attempts per month
  const KEY_UID              = 'mc_uid';                 // anonymous user id (if you later need it)

  const PASS_MARK    = 0.8;
  const BONUS        = 50;
  const QUIZ_SECONDS = 10 * 60; // 10 minutes

  // ---------- generic helpers ----------
  const getJSON = (k,f)=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(f))}catch(e){return f}};
  const setJSON = (k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const getPoints = ()=>parseInt(localStorage.getItem(KEY_POINTS)||'0',10);
  const setPoints = v=>localStorage.setItem(KEY_POINTS,String(v));
  const addPoints = n=>setPoints(getPoints()+n);
  const getBadges = ()=>getJSON(KEY_BADGES,[]);
  const setBadges = a=>setJSON(KEY_BADGES,a);
  const awardBadge = id=>{
    const b=getBadges();
    if(!b.includes(id)){b.push(id);setBadges(b);return true;}
    return false;
  };
  const logPass = pct=>{
    const log=getJSON(KEY_TRAINING_LOG,[]);
    log.push({date:new Date().toISOString(),pct});
    setJSON(KEY_TRAINING_LOG,log);
  };

  // ---------- anonymous uid (future-proofing) ----------
  function getUid(){
    let u = localStorage.getItem(KEY_UID);
    if(!u){
      u = 'mc_' + Math.random().toString(36).slice(2);
      localStorage.setItem(KEY_UID,u);
    }
    return u;
  }

  // ---------- monthly attempt limit (max 2 / month) ----------
  function currentMonthKey(){
    const d=new Date();
    const m=String(d.getMonth()+1).padStart(2,'0');
    return d.getFullYear()+'-'+m; // e.g. 2025-11
  }
  function getAttemptMap(){
    return getJSON(KEY_TRAINING_ATTEMPTS,{});
  }
  function attemptsThisMonth(){
    const map=getAttemptMap();
    return map[currentMonthKey()] || 0;
  }
  function recordAttempt(){
    const map=getAttemptMap();
    const mk=currentMonthKey();
    map[mk]=(map[mk]||0)+1;
    setJSON(KEY_TRAINING_ATTEMPTS,map);
    return map[mk];
  }
  function canTakeQuiz(){
    return attemptsThisMonth() < 2;
  }

  // ---------- Lesson navigation ----------
  const lessons        = Array.from(document.querySelectorAll('.lesson'));
  const totalLessons   = lessons.length;
  const prevLessonBtn  = document.getElementById('prevLesson');
  const nextLessonBtn  = document.getElementById('nextLesson');
  const lessonStatus   = document.getElementById('lessonStatus');
  const lessonHint     = document.getElementById('lessonHint');
  const startQuizBtn   = document.getElementById('startQuiz');

  let currentLessonIndex   = 0;
  let completedLessonsCount= parseInt(localStorage.getItem(KEY_LESSON_PROGRESS) || '0', 10);
  if (completedLessonsCount < 0) completedLessonsCount = 0;
  if (completedLessonsCount > totalLessons) completedLessonsCount = totalLessons;

  function showLesson(index){
    lessons.forEach((sec,i)=>{
      sec.style.display = (i===index) ? 'block' : 'none';
    });
    currentLessonIndex = index;
    if(lessonStatus){
      lessonStatus.textContent = `Lesson ${index+1} of ${totalLessons}`;
    }
    if(prevLessonBtn){
      prevLessonBtn.disabled = index === 0;
    }
    if(nextLessonBtn){
      nextLessonBtn.textContent = (index === totalLessons-1) ? 'Finish lessons' : 'Next lesson';
    }
  }

  function unlockQuiz(){
    if(startQuizBtn){
      startQuizBtn.disabled = false;
    }
    if(lessonHint){
      lessonHint.textContent = 'All lessons completed. You can now start the quiz below.';
    }
  }

  if(prevLessonBtn && nextLessonBtn && lessons.length){
    if(completedLessonsCount >= 1){
      const idx = Math.min(completedLessonsCount-1, totalLessons-1);
      showLesson(idx);
    } else {
      showLesson(0);
    }

    if(completedLessonsCount >= totalLessons){
      unlockQuiz();
    }

    prevLessonBtn.addEventListener('click', ()=>{
      if(currentLessonIndex > 0){
        showLesson(currentLessonIndex - 1);
      }
    });

    nextLessonBtn.addEventListener('click', ()=>{
      if(currentLessonIndex < totalLessons-1){
        if(completedLessonsCount < currentLessonIndex+1){
          completedLessonsCount = currentLessonIndex+1;
          localStorage.setItem(KEY_LESSON_PROGRESS, String(completedLessonsCount));
        }
        showLesson(currentLessonIndex + 1);
      } else {
        completedLessonsCount = totalLessons;
        localStorage.setItem(KEY_LESSON_PROGRESS, String(completedLessonsCount));
        unlockQuiz();
      }
    });
  }

  // ---------- Questions (15) ----------
  const QUESTIONS=[
    {q:"Which response best shows safe listening?",a:["Interrupt to give solutions","Listen, reflect, ask open questions","Tell them others have it worse"],c:1},
    {q:"Which is an immediate red flag?",a:["Occasional sadness","Active self-harm plan","Feeling tired after work"],c:1},
    {q:"Volunteers should avoid:",a:["Offering clinic options","Promising limited confidentiality","Giving medical advice/diagnoses"],c:2},
    {q:"If danger is happening now, what’s the first action?",a:["Keep chatting","Call 112 immediately","Tell them to relax"],c:1},
    {q:"Privacy-first logging means:",a:["Use initials only, minimal facts","Write their full name and story","Screenshot the chat for records"],c:0},
    {q:"Before making a referral you should:",a:["Get consent and offer choices","Choose one clinic for them","Ask for their full medical history"],c:0},
    {q:"Boundaries help because they:",a:["Prevent burnout and role drift","Make you uncaring","Stop you from listening"],c:0},
    {q:"A good empathic reflection is:",a:["You’re overreacting","It sounds like this is hard for you","Calm down"],c:1},
    {q:"If unsure what to do:",a:["Do nothing","Escalate to supervisor/safeguarding lead","Post on social media for advice"],c:1},
    {q:"A small next step might be:",a:["Plan their whole life","Agree they call a clinic tomorrow","End abruptly"],c:1},
    {q:"Which is appropriate to log?",a:["Date + concern + action taken","Their full name and address","Screenshots of messages"],c:0},
    {q:"Cultural sensitivity includes:",a:["Respecting beliefs & language","Assuming everyone thinks alike","Correcting their culture"],c:0},
    {q:"When a child may be at risk, you should:",a:["Keep it secret","Follow safeguarding protocol and escalate","Handle it alone without records"],c:1},
    {q:"During listening, silence is:",a:["Useful to give space","A sign you’re failing","To be avoided"],c:0},
    {q:"Consent in referrals means:",a:["Acting without telling them","Getting their informed permission","Telling them they must accept"],c:1}
  ];

  // ---------- DOM for quiz ----------
  const form      = document.getElementById('quizForm');
  const preQuizBar= document.getElementById('preQuizBar');
  const quizBtns  = document.getElementById('quizBtns');
  const result    = document.getElementById('quizResult');
  const post      = document.getElementById('postPass');
  const timeLeftEl= document.getElementById('timeLeft');

  function renderQuiz(){
    form.innerHTML=QUESTIONS.map((Q,i)=>`
      <fieldset class="q">
        <legend>Q${i+1}. ${Q.q}</legend>
        ${Q.a.map((opt,j)=>`<label><input type="radio" name="q${i}" value="${j}" required/> ${opt}</label>`).join('')}
      </fieldset>
    `).join('');
  }

  // ---------- Timer ----------
  let timerId=null;
  function fmt(sec){ const m=Math.floor(sec/60), s=sec%60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

  function remainingSeconds(){
    const started=parseInt(localStorage.getItem(KEY_TIMER_START)||'0',10);
    if(!started) return QUIZ_SECONDS;
    const elapsed=Math.floor((Date.now()-started)/1000);
    return Math.max(0, QUIZ_SECONDS - elapsed);
  }

  function tickTimer(){
    const r=remainingSeconds();
    timeLeftEl.textContent=fmt(r);
    if(r<=60) timeLeftEl.classList.add('warn');
    if(r<=0){
      clearInterval(timerId);
      timeLeftEl.textContent='00:00';
      autoSubmitOnTimeout();
    }
  }

  function startTimer(){
    const now=Date.now();
    localStorage.setItem(KEY_TIMER_START,String(now));
    tickTimer();
    timerId=setInterval(tickTimer,1000);
    try{ window.plausible && window.plausible('TrainingTimerStarted'); }catch(e){}
  }

  function disableQuiz(){
    form.querySelectorAll('input[type=radio]').forEach(el=>el.disabled=true);
    const sBtn=document.getElementById('submitQuiz');
    if(sBtn) sBtn.disabled=true;
  }

  function autoSubmitOnTimeout(){
    try{ window.plausible && window.plausible('TrainingTimerExpired'); }catch(e){}
    gradeQuiz(true);
    disableQuiz();
  }

  // ---------- Events ----------
  let gradedAlready = false; // prevent double-counting attempts

  if(startQuizBtn){
    startQuizBtn.onclick=()=>{
      if(startQuizBtn.disabled){
        alert('Please complete all lessons before starting the quiz.');
        return;
      }
      if(!canTakeQuiz()){
        alert('You have already used your two quiz attempts for this month. Please try again next month.');
        return;
      }
      gradedAlready = false;
      preQuizBar.style.display='none';
      form.style.display='block';
      quizBtns.style.display='flex';
      renderQuiz();
      localStorage.removeItem(KEY_TIMER_START);
      startTimer();
    };
  }

  document.getElementById('submitQuiz').onclick=()=>gradeQuiz(false);

  document.getElementById('resetQuiz').onclick=()=>{
    form.reset();
    result.style.display='none'; post.style.display='none';
    localStorage.removeItem(KEY_TIMER_START);
    timeLeftEl.classList.remove('warn');
    timeLeftEl.textContent=fmt(QUIZ_SECONDS);
    clearInterval(timerId);
    form.style.display='none';
    quizBtns.style.display='none';
    preQuizBar.style.display='flex';
    gradedAlready = false;
  };

  // ---------- Grading ----------
  function gradeQuiz(timedOut){
    if(form.style.display==='none'){ return; }
    if(gradedAlready){ return; }              // avoid double record
    if(!timedOut && !form.checkValidity()){   // normal validation
      form.reportValidity();
      return;
    }
    gradedAlready = true;

    // count this attempt
    const attemptCount = recordAttempt();

    let correct=0;
    QUESTIONS.forEach((Q,i)=>{
      const ch=form.querySelector(`input[name=q${i}]:checked`);
      if(ch && parseInt(ch.value,10)===Q.c) correct++;
    });

    const pct=correct/QUESTIONS.length;
    setJSON(KEY_TRAINING,{pct,date:new Date().toISOString()});
    const pass=pct>=PASS_MARK;

    result.style.display='block';
    result.className='result '+(pass?'good':'bad');
    const tag = timedOut ? ' (time up)' : '';
    let msg=`You scored ${correct}/${QUESTIONS.length} (${Math.round(pct*100)}%). ${pass?'You passed!':'Try again.'}${tag}`;

    if(!pass && attemptCount >= 2){
      msg += ' You have reached your two attempts for this month. Please try again next month.';
    }
    result.textContent = msg;

    if(pass){
      awardBadge('volunteer_trained');
      addPoints(BONUS);
      logPass(pct);
      post.style.display='block';
      try{ window.plausible && window.plausible('VolunteerQuizPassed',{props:{score:Math.round(pct*100)}});}catch(e){}
    }else{
      post.style.display='none';
      try{ window.plausible && window.plausible('VolunteerQuizFailed',{props:{score:Math.round(pct*100), timedOut: !!timedOut}});}catch(e){}
    }
  }

  // ---------- Certificate (with cert_id + backend logging) ----------
  function generateCertId() {
    const t = new Date();
    const y = t.getFullYear();
    const m = String(t.getMonth()+1).padStart(2,'0');
    const d = String(t.getDate()).padStart(2,'0');
    const rand = Math.random().toString(36).slice(-4).toUpperCase();
    return `MC-CERT-${y}${m}${d}-${rand}`;
  }

  const makeBtn   = document.getElementById('makeCert'),
        certInput = document.getElementById('certName'),
        hint      = document.getElementById('certHint');

  if(makeBtn){
    makeBtn.onclick=()=>{
      const name=(certInput.value||'').trim();
      if(!name){
        alert('Enter your name');
        return;
      }
      const t      = getJSON(KEY_TRAINING,{pct:1,date:new Date().toISOString()});
      const score  = Math.round(t.pct*100);
      const dateIso= t.date || new Date().toISOString();
      const certId = generateCertId();

      const url=`certificate.html?name=${encodeURIComponent(name)}&score=${score}&date=${encodeURIComponent(dateIso)}&cert_id=${encodeURIComponent(certId)}`;

      hint.style.display='block';
      hint.innerHTML=`Your certificate is ready: <a href="${url}" target="_blank" rel="noopener" class="btn btn-ghost">Open Certificate</a>`;

      // Log pass + cert details into your Certificates sheet
      try{
        fetch(GAS_URL + '?auth=speakout123', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            type:   'certificate_issue',
            cert_id: certId,
            name,
            score,
            date:   dateIso
          })
        }).then(r=>r.text()).then(txt=>{
          try{ console.log('Cert logged:', JSON.parse(txt)); }
          catch{ console.log('Cert logged raw:', txt); }
        }).catch(e=>console.warn('Cert logging failed:', e));
      }catch(e){
        console.warn('Cert fetch block failed:', e);
      }

      try{ window.plausible && window.plausible('VolunteerCertificateOpen',{props:{score}});}catch(e){}
    };
  }

  // Initialize timer display for first load
  timeLeftEl.textContent = '10:00';
</script>

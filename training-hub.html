<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>MindCheck Joint Volunteer Training ‚Äî SpeakOut ‚Ä¢ Synia Aid ‚Ä¢ AfriHud</title>
  <link rel="icon" href="favicon.png"/>
  <link rel="stylesheet" href="mc-theme.css"/>
  <meta name="theme-color" content="#22c55e"/>

  <!-- Plausible (optional) -->
  <script defer data-domain="speakoutmentalhealth.github.io" src="https://plausible.io/js/script.js"></script>

  <style>
    :root{
      --green:#22c55e; --greenDark:#16a34a;
      --ink:#062436; --muted:#52606d;
      --card:#fff; --border:#e8eef5;
      --bg:#f5fdf8; --shadow:0 10px 25px rgba(15,23,42,.06);
      --radius:16px;
    }

    /* Mobile-safe layout */
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(34,197,94,.10), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(34,197,94,.08), transparent 55%),
                  var(--bg);
      color:var(--ink);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-text-size-adjust: 100%;
      overflow-x:hidden;
    }

    header{
      background: linear-gradient(90deg, var(--greenDark), var(--green));
      color:#fff;
      padding:16px 14px;
      font-weight:900;
      letter-spacing:.2px;
    }

    .wrap{
      max-width: 900px;
      margin: 0 auto;
      padding: 14px 12px 120px; /* bottom space for sticky nav */
      box-sizing:border-box;
    }

    .hero{
      border-radius: 20px;
      background: rgba(255,255,255,.65);
      border:1px solid rgba(255,255,255,.65);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:hidden;
    }

    .heroTop{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .heroTitle{
      flex:1 1 260px;
      min-width: 240px;
    }

    .heroTitle h1{
      margin:0;
      font-size: clamp(1.15rem, 3.8vw, 1.8rem);
      line-height:1.2;
      font-weight: 950;
      color:#083a28;
    }

    .heroTitle p{
      margin:.5rem 0 0;
      color: var(--muted);
      font-weight:600;
      line-height:1.4;
      font-size: .98rem;
    }

    .heroBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-start;
    }

    .btn{
      border:none;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:.15s;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }
    .btn:active{ transform: translateY(1px); }

    .btn-primary{ background: var(--green); color:#fff; box-shadow: 0 10px 20px rgba(34,197,94,.22); }
    .btn-primary:hover{ background: var(--greenDark); }
    .btn-ghost{ background:#fff; color: var(--ink); border:1px solid rgba(0,0,0,.08); }

    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
      align-items:center;
    }

    .pill{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight:900;
      font-size:.92rem;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }

    .progressWrap{
      margin-top:10px;
      background: rgba(255,255,255,.85);
      border:1px solid rgba(0,0,0,.06);
      border-radius: 14px;
      padding: 10px;
    }
    .bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(34,197,94,.15);
      overflow:hidden;
      border: 1px solid rgba(34,197,94,.18);
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--greenDark), var(--green));
      border-radius: 999px;
      transition: width .25s ease;
    }
    .barMeta{
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      color: var(--muted);
      font-weight:800;
      font-size:.92rem;
    }

    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
      margin-top: 12px;
    }
    .muted{ color: var(--muted); }

    /* Lessons */
    .lesson{
      display:none;
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-top: 12px;
      text-align:left;
    }
    .lesson h2{
      margin:.2rem 0 .3rem;
      font-size: 1.15rem;
    }
    .lesson h3{
      margin: 14px 0 6px;
      font-size: 1.05rem;
    }
    .lesson p, .lesson li{
      line-height: 1.65;
      color: #243b53;
      font-weight: 600;
    }
    .lesson ul{ padding-left: 18px; }

    /* Bigger images */
    .lessonImg{
      width:100%;
      height:auto;
      border-radius: 16px;
      margin: 10px 0 12px;
      display:block;
      border:1px solid rgba(0,0,0,.06);
      box-shadow: 0 10px 20px rgba(2,23,34,.06);
      max-height: 340px;
      object-fit: cover;
    }
    @media (min-width: 720px){
      .lessonImg{ max-height: 420px; }
    }

    .callout{
      background: #ecfdf3;
      border: 1px solid #bbf7d0;
      border-radius: 14px;
      padding: 12px;
      font-weight:900;
      color:#065f46;
    }

    /* Sticky lesson nav (mobile-first) */
    .stickyNav{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0,0,0,.06);
      z-index: 50;
    }
    .stickyInner{
      max-width: 900px;
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .navLeft{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .navRight{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .mini{
      font-weight: 950;
      border-radius: 999px;
      padding: 8px 12px;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }

    /* Quiz area */
    .quiz-card{
      display:none; /* unlocked after lesson 5 */
    }

    .q{
      margin: 12px 0;
      text-align:left;
    }
    .q legend{
      font-weight: 950;
      margin-bottom: 8px;
      color:#0b3a2a;
    }
    .q label{
      display:block;
      padding: 10px 10px;
      border:1px solid var(--border);
      border-radius: 12px;
      margin: 8px 0;
      cursor:pointer;
      font-weight: 800;
      background: #fff;
      transition:.12s;
    }
    .q label:hover{ transform: translateY(-1px); }

    .result{
      display:none;
      margin-top:12px;
      font-weight: 950;
      padding: 12px;
      border-radius: 14px;
      border:1px solid rgba(0,0,0,.08);
    }
    .good{ background:#ecfdf3; color:#065f46; border-color:#bbf7d0; }
    .bad{ background:#fef2f2; color:#7f1d1d; border-color:#fecaca; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    input, select{
      width:100%;
      box-sizing:border-box;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.15);
      font-weight:700;
      background:#fff;
    }
    .field{ flex: 1 1 200px; min-width: 170px; }

    footer{
      margin: 18px 0 0;
      text-align:center;
      color: var(--muted);
      font-weight: 700;
      padding-bottom: 16px;
    }
    footer a{ color: inherit; }
  </style>
</head>

<body>
  <header>üß† MindCheck Nigeria ‚Äî SpeakOut ‚Ä¢ Synia Aid Foundation ‚Ä¢ AfriHud</header>

  <div class="wrap">

    <!-- ONE-TIME INFO (shows once, not inside lessons) -->
    <section class="hero" id="introCard">
      <div class="heroTop">
        <div class="heroTitle">
          <h1>Joint Volunteer Training (Certified)</h1>
          <p>
            Complete <b>5 lessons</b> + a short quiz (10 minutes). Pass mark: <b>80%</b>.
            If you pass, you‚Äôll unlock your <b>Volunteer Trained</b> badge (+50 XP) and download your certificate.
          </p>
        </div>
        <div class="heroBtns">
          <a class="btn btn-primary" href="volunteers.html">üë• Volunteer Zone</a>
          <a class="btn btn-ghost" href="resources.html">üè• Clinics & Resources</a>
        </div>
      </div>

      <div class="pillRow">
        <span class="pill">‚≠ê XP: <span id="xpPill">0</span></span>
        <span class="pill">üèÖ Badge: <span id="badgePill">Locked</span></span>
        <span class="pill">üìò Lesson: <span id="lessonPill">1 / 5</span></span>
      </div>

      <div class="progressWrap">
        <div class="bar" aria-label="Lesson progress bar">
          <div id="barFill"></div>
        </div>
        <div class="barMeta">
          <span><span id="pctText">0%</span> complete</span>
          <span id="saveText">Saved</span>
        </div>
      </div>

      <div class="card" style="margin-top:12px;text-align:left;">
        <b>Important (read once)</b>
        <p class="muted" style="margin:.5rem 0 0;">
          ‚úÖ This training is for <b>safe listening + referral</b> (not emergency response).<br/>
          ‚ö† If someone is in immediate danger: call <b>112</b> or find a trusted adult immediately.<br/>
          üîí Keep privacy: log only the minimum necessary. No screenshots, no full names.
        </p>
      </div>

      <div class="card" style="text-align:left;">
        <b>About this partnership</b>
        <p class="muted" style="margin:.5rem 0;">
          This training is jointly delivered by:
        </p>
        <ul style="margin:.2rem 0 0;padding-left:18px;">
          <li><b>SpeakOut Mental Health Outreach</b> ‚Äî campus/community education, safe listening, referrals.</li>
          <li><b>Synia Aid Foundation</b> ‚Äî education + poverty relief; support for vulnerable learners & families.</li>
          <li><b>AfriHud</b> ‚Äî humanitarian & development projects (youth/community development).</li>
        </ul>
      </div>
    </section>

    <!-- LESSONS (one at a time) -->
    <section class="lesson" data-lesson="1">
      <h2>Lesson 1 ‚Äî Safe Listening Basics (L-I-S-T-E-N)</h2>
      <img class="lessonImg" src="icons/listen.png" alt="Safe Listening"/>
      <p class="muted">
        Safe listening is a simple skill that helps someone feel calm enough to choose safer next steps.
        You are not ‚Äúfixing‚Äù them ‚Äî you are creating safety, clarity, and connection.
      </p>

      <h3>The L-I-S-T-E-N method</h3>
      <ul>
        <li><b>L ‚Äî Listen:</b> Full attention. Phone down. Soft voice. Allow silence.</li>
        <li><b>I ‚Äî Inquire:</b> Ask open questions: ‚ÄúWhat has been hardest?‚Äù ‚ÄúWhen did it start?‚Äù</li>
        <li><b>S ‚Äî Summarize:</b> Repeat key points: ‚ÄúSo school pressure + money worries are affecting sleep.‚Äù</li>
        <li><b>T ‚Äî Thank:</b> ‚ÄúThank you for trusting me.‚Äù</li>
        <li><b>E ‚Äî Empathize:</b> Validate feelings: ‚ÄúThat sounds heavy.‚Äù ‚ÄúAnyone would feel overwhelmed.‚Äù</li>
        <li><b>N ‚Äî Next step:</b> Choose one small step for <i>today</i> (breathing, water, clinic options, trusted adult).</li>
      </ul>

      <div class="callout">
        Example: <br/>
        Person: ‚ÄúI‚Äôm tired of everything.‚Äù <br/>
        You: ‚ÄúI‚Äôm glad you told me. What has today felt like?‚Äù ‚Üí summarize ‚Üí empathize ‚Üí ‚ÄúWould you like a quick breathing exercise or to see support options?‚Äù
      </div>

      <h3>Do / Don‚Äôt</h3>
      <ul>
        <li><b>Do:</b> Ask permission before sensitive questions; keep tone calm; use short supportive phrases.</li>
        <li><b>Don‚Äôt:</b> Preach, shame, compare (‚Äúothers have it worse‚Äù), or rush into advice.</li>
      </ul>
    </section>

    <section class="lesson" data-lesson="2">
      <h2>Lesson 2 ‚Äî Red Flags & Immediate Danger</h2>
      <img class="lessonImg" src="icons/red-flags.png" alt="Red Flags"/>
      <p class="muted">
        Your first responsibility is safety. Most chats are not emergencies ‚Äî but some require immediate escalation.
      </p>

      <h3>Immediate red flags (act now)</h3>
      <ul>
        <li>Self-harm plan or intent: ‚ÄúI will take pills tonight.‚Äù</li>
        <li>Ongoing violence/abuse/threats right now.</li>
        <li>Child/vulnerable person at risk (safeguarding).</li>
        <li>Severe confusion, hallucinations commanding harm, or extreme agitation.</li>
      </ul>

      <h3>What to do (simple steps)</h3>
      <ul>
        <li>Stay present: ‚ÄúYour safety matters. I‚Äôm here.‚Äù</li>
        <li>Call <b>112</b> (or the local emergency response) immediately.</li>
        <li>Escalate to your supervisor/safeguarding lead.</li>
        <li>Log only minimum facts: date + concern + action taken.</li>
      </ul>

      <div class="callout">
        Example: <br/>
        Person: ‚ÄúI bought pills.‚Äù <br/>
        You: ‚ÄúThank you for telling me. Are you alone? I‚Äôm calling 112 now so help can reach you. Stay with me.‚Äù
      </div>
    </section>

    <section class="lesson" data-lesson="3">
      <h2>Lesson 3 ‚Äî Boundaries & Ethical Referral</h2>
      <img class="lessonImg" src="icons/referral.png" alt="Referral"/>
      <p class="muted">
        Boundaries protect you and the person. Ethical referral means offering choices, consent, and dignity.
      </p>

      <h3>Your scope (what you can do)</h3>
      <ul>
        <li>Supportive listening, calming strategies, and information.</li>
        <li>Help them choose an option: clinic, counsellor, trusted adult, helpline.</li>
      </ul>

      <h3>What you should NOT do</h3>
      <ul>
        <li>Diagnose, prescribe, or promise outcomes.</li>
        <li>Become a 24/7 personal hotline.</li>
      </ul>

      <h3>Ethical referral (step-by-step)</h3>
      <ul>
        <li><b>Ask consent:</b> ‚ÄúWould you like support options?‚Äù</li>
        <li><b>Offer 2‚Äì3 choices:</b> based on cost/location/comfort.</li>
        <li><b>Plan follow-up:</b> ‚ÄúCan I check in tomorrow?‚Äù</li>
      </ul>

      <div class="callout">
        Example: <br/>
        Person: ‚ÄúI‚Äôm scared to go alone.‚Äù <br/>
        You: ‚ÄúWould a WhatsApp/phone option help first? We can plan one small step for today.‚Äù
      </div>
    </section>

    <section class="lesson" data-lesson="4">
      <h2>Lesson 4 ‚Äî Privacy-First Logging (Minimum Necessary)</h2>
      <img class="lessonImg" src="icons/privacy.png" alt="Privacy"/>
      <p class="muted">
        Notes help improve support ‚Äî but privacy must come first. Record only what is needed for safety + learning.
      </p>

      <h3>Log this</h3>
      <ul>
        <li>Date/time</li>
        <li>General concern (stress, anxiety, sleep, bullying)</li>
        <li>Action taken (breathing tip, referral options, escalated to supervisor)</li>
      </ul>

      <h3>Do NOT log</h3>
      <ul>
        <li>Full names, phone numbers, hostel addresses</li>
        <li>Screenshots, photos, long transcripts</li>
        <li>Judgments (‚Äúdramatic‚Äù, ‚Äúattention seeker‚Äù)</li>
      </ul>

      <div class="callout">
        Good example log: <br/>
        ‚Äú2026-01-02 ‚Ä¢ exam stress + poor sleep ‚Ä¢ taught 4-7-8 breathing ‚Ä¢ offered clinic list ‚Ä¢ person chose WhatsApp support.‚Äù
      </div>
    </section>

    <section class="lesson" data-lesson="5">
      <h2>Lesson 5 ‚Äî Cultural Sensitivity & Volunteer Self-Care</h2>
      <img class="lessonImg" src="icons/culture.png" alt="Culture"/>
      <p class="muted">
        People describe distress through culture, faith, and family expectations. Respect improves trust and outcomes.
        Also: your wellbeing matters ‚Äî burnout helps nobody.
      </p>

      <h3>Cultural sensitivity</h3>
      <ul>
        <li>Ask preferences: ‚ÄúWhat language/name should we use?‚Äù</li>
        <li>Respect faith: validate prayer + offer additional options.</li>
        <li>Avoid labels; use ‚Äúgoing through a hard time‚Äù.</li>
      </ul>

      <h3>Self-care</h3>
      <ul>
        <li>Debrief after tough chats with a supervisor.</li>
        <li>Hydrate, rest, set limits on heavy conversations per day.</li>
        <li>If overwhelmed: pause and escalate ‚Äî that‚Äôs professional, not failure.</li>
      </ul>

      <div class="callout">
        Example: <br/>
        Person: ‚ÄúMy family says counselling is shameful.‚Äù <br/>
        You: ‚ÄúI understand. Many people combine faith + family support + counselling. Would you like options you can choose from privately?‚Äù
      </div>
    </section>

    <!-- QUIZ (unlocks after lesson 5) -->
    <section class="card quiz-card" id="quizCard">
      <h2>Volunteer Quiz (Unlocked after Lesson 5)</h2>
      <p class="muted">
        Time: <b>10 minutes</b> ‚Ä¢ Pass mark: <b>80%</b> ‚Ä¢ Attempts: <b>2 per month</b>
        (<span id="attemptInfo">0 / 2</span>)
      </p>

      <div class="card" style="text-align:left;">
        <b>Volunteer details (required)</b>
        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label><b>Full name</b></label>
            <input id="candName" type="text" placeholder="Your full name"/>
          </div>
          <div class="field">
            <label><b>Age</b></label>
            <input id="candAge" type="number" min="10" max="120" placeholder="Age"/>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label><b>Location (city/state)</b></label>
            <input id="candLocation" type="text" placeholder="e.g. Abuja, Nasarawa"/>
          </div>
          <div class="field">
            <label><b>Preferred role</b></label>
            <select id="candRole">
              <option value="">Select</option>
              <option>Campus volunteer</option>
              <option>Community volunteer</option>
              <option>Online support volunteer</option>
              <option>Clinic / hospital liaison</option>
              <option>Other</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label><b>NGO of choice</b></label>
            <select id="candNgo">
              <option value="">Select</option>
              <option>SpeakOut Mental Health Outreach</option>
              <option>Synia Aid Foundation</option>
              <option>AfriHud (Africa Initiative for Humanitarian Development)</option>
              <option>Other</option>
            </select>
          </div>
          <div class="field">
            <label><b>WhatsApp number</b></label>
            <input id="candWhatsApp" type="tel" placeholder="+234 80 0000 0000"/>
          </div>
        </div>

        <p class="muted" style="margin:.7rem 0 0;">
          This info is saved to the sheet only if you <b>pass</b>.
        </p>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn btn-primary" id="startQuiz" type="button" disabled>Start Quiz</button>
        <button class="btn btn-ghost" id="resetQuiz" type="button" style="display:none;">Reset</button>
      </div>

      <p class="muted" style="margin-top:10px;">
        Time left: <b><span id="timeLeft">10:00</span></b>
      </p>

      <form id="quizForm" style="display:none;"></form>

      <div class="row" style="margin-top:10px; display:none;" id="quizBtns">
        <button class="btn btn-primary" id="submitQuiz" type="button">Submit Quiz</button>
      </div>

      <div id="quizResult" class="result" aria-live="polite"></div>

      <div id="postPass" class="card" style="display:none; text-align:left; margin-top:12px;">
        <h3>‚úÖ You passed!</h3>
        <p class="muted">
          Your <b>Volunteer Trained</b> badge is unlocked (+50 XP). You can now generate your certificate.
        </p>

        <label style="display:block;margin:10px 0 6px;font-weight:900;">Name to appear on certificate</label>
        <input id="certName" type="text" placeholder="Type your name exactly"/>

        <div class="row" style="margin-top:10px;">
          <button class="btn btn-primary" id="makeCert" type="button">Generate Certificate</button>
          <a class="btn btn-ghost" href="verify.html" target="_blank" rel="noopener">Verify Certificate</a>
        </div>

        <p id="certHint" class="muted" style="display:none;margin-top:10px;"></p>
      </div>
    </section>

    <footer>
      üîí <a href="privacy.html">Privacy</a> ‚Ä¢ üìÑ <a href="terms.html">Terms</a> ‚Ä¢ üè• <a href="resources.html">Clinics & Resources</a> ‚Ä¢ ‚úâÔ∏è <a href="mailto:speaaakout@gmail.com">speaaakout@gmail.com</a>
    </footer>
  </div>

  <!-- Sticky bottom lesson nav -->
  <div class="stickyNav" id="stickyNav">
    <div class="stickyInner">
      <div class="navLeft">
        <span class="mini">üìç <span id="lessonLabel">Lesson 1</span></span>
        <span class="mini">‚úÖ Completed: <span id="doneLabel">0</span> / 5</span>
      </div>
      <div class="navRight">
        <button class="btn btn-ghost" id="prevLesson" type="button">‚¨Ö Previous</button>
        <button class="btn btn-primary" id="nextLesson" type="button">Next ‚ûú</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /********* CONFIG *********/
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbxmkC25_qQhxydDmRjjZa_efL-wQwGYysAIIxJ3YkIavJqLr5XVsNHv9okO2d3Epm4vfA/exec';
  const BEARER  = 'speakout123';

  const KEY_POINTS = 'mc_points';
  const KEY_BADGES = 'mc_badges';
  const KEY_UID = 'mc_uid';

  const KEY_LESSON_PROGRESS = 'mc_training_lessons_done';
  const KEY_TRAINING_ATTEMPTS = 'mc_training_attempts';
  const KEY_TIMER_START = 'mc_training_timer_start';
  const KEY_CANDIDATE = 'mc_training_candidate';
  const KEY_TRAINING = 'mc_training';

  const PASS_MARK = 0.8;
  const BONUS = 50;
  const QUIZ_SECONDS = 10 * 60;

  /********* UTIL *********/
  const $ = (id) => document.getElementById(id);
  const getJSON = (k,f)=>{ try{ return JSON.parse(localStorage.getItem(k) || JSON.stringify(f)); } catch(e){ return f; } };
  const setJSON = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
  const getPoints = ()=> parseInt(localStorage.getItem(KEY_POINTS) || '0', 10);
  const setPoints = (v)=> localStorage.setItem(KEY_POINTS, String(v));
  const addPoints = (n)=> setPoints(getPoints() + n);
  const getBadges = ()=> getJSON(KEY_BADGES, []);
  const setBadges = (a)=> setJSON(KEY_BADGES, a);
  const awardBadge = (id)=>{ const b=getBadges(); if(!b.includes(id)){ b.push(id); setBadges(b); return true; } return false; };

  function getUid(){
    let u = localStorage.getItem(KEY_UID);
    if(!u){
      u = 'mc_' + Math.random().toString(36).slice(2);
      localStorage.setItem(KEY_UID, u);
    }
    return u;
  }

  async function postToGas(payload){
    try{
      await fetch(GAS_URL + '?auth=' + encodeURIComponent(BEARER), {
        method:'POST',
        mode:'no-cors',
        headers:{ 'Content-Type':'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });
    }catch(e){
      console.error('GAS post error', e);
    }
  }

  function monthKey(){
    const d=new Date();
    const m=String(d.getMonth()+1).padStart(2,'0');
    return `${d.getFullYear()}-${m}`;
  }
  function getAttemptMap(){ return getJSON(KEY_TRAINING_ATTEMPTS, {}); }
  function attemptsThisMonth(){ return (getAttemptMap()[monthKey()] || 0); }
  function recordAttempt(){
    const map=getAttemptMap();
    const mk=monthKey();
    map[mk]=(map[mk]||0)+1;
    setJSON(KEY_TRAINING_ATTEMPTS, map);
    return map[mk];
  }
  function canTakeQuiz(){ return attemptsThisMonth() < 2; }

  /********* TOP UI PULLS *********/
  function refreshTopPills(completed, total){
    $('xpPill').textContent = getPoints();
    const b = getBadges();
    $('badgePill').textContent = b.includes('volunteer_trained') ? 'Volunteer Trained' : 'Locked';
    $('lessonPill').textContent = `${Math.min(completed+1, total)} / ${total}`;

    const pct = Math.round((completed / total) * 100);
    $('pctText').textContent = `${pct}%`;
    $('barFill').style.width = `${pct}%`;

    $('doneLabel').textContent = completed;
  }

  /********* LESSON NAV *********/
  const lessons = Array.from(document.querySelectorAll('.lesson'));
  const totalLessons = lessons.length;

  let completedLessons = parseInt(localStorage.getItem(KEY_LESSON_PROGRESS) || '0', 10);
  if(!Number.isFinite(completedLessons) || completedLessons < 0) completedLessons = 0;
  if(completedLessons > totalLessons) completedLessons = totalLessons;

  let currentLessonIndex = Math.min(Math.max(completedLessons, 0), totalLessons-1);

  function showLesson(index){
    lessons.forEach((sec,i)=> sec.style.display = (i===index ? 'block' : 'none'));
    currentLessonIndex = index;

    $('lessonLabel').textContent = `Lesson ${index+1}`;
    $('prevLesson').disabled = index === 0;

    $('nextLesson').textContent = (index === totalLessons-1) ? 'Finish Lessons ‚úÖ' : 'Next ‚ûú';

    // update pills/progress (completed is "how many finished", not current index)
    refreshTopPills(completedLessons, totalLessons);

    // scroll to top of lesson area (nice on mobile)
    const top = document.querySelector('.wrap');
    if(top) top.scrollIntoView({behavior:'smooth', block:'start'});
  }

  function markCurrentCompleted(){
    const finishedUpTo = currentLessonIndex + 1;
    if(finishedUpTo > completedLessons){
      completedLessons = finishedUpTo;
      localStorage.setItem(KEY_LESSON_PROGRESS, String(completedLessons));
    }
  }

  $('prevLesson').addEventListener('click', () => {
    if(currentLessonIndex > 0) showLesson(currentLessonIndex - 1);
  });

  $('nextLesson').addEventListener('click', () => {
    // mark this lesson as completed
    markCurrentCompleted();

    if(currentLessonIndex < totalLessons-1){
      showLesson(currentLessonIndex + 1);
      return;
    }

    // finished all lessons
    completedLessons = totalLessons;
    localStorage.setItem(KEY_LESSON_PROGRESS, String(completedLessons));
    refreshTopPills(completedLessons, totalLessons);

    // unlock quiz section
    $('quizCard').style.display = 'block';
    $('stickyNav').style.display = 'none';

    // jump to quiz
    $('quizCard').scrollIntoView({behavior:'smooth', block:'start'});
    updateStartQuizState();
  });

  // initial render
  showLesson(currentLessonIndex);

  /********* QUIZ *********/
  const QUESTIONS=[
    {q:"Which response best shows safe listening?",a:["Interrupt to give solutions","Listen, reflect, ask open questions","Tell them others have it worse"],c:1},
    {q:"Which is an immediate red flag?",a:["Occasional sadness","Active self-harm plan","Feeling tired after work"],c:1},
    {q:"Volunteers should avoid:",a:["Offering clinic options","Promising limited confidentiality","Giving medical advice/diagnoses"],c:2},
    {q:"If danger is happening now, what‚Äôs the first action?",a:["Keep chatting","Call 112 immediately","Tell them to relax"],c:1},
    {q:"Privacy-first logging means:",a:["Use minimal facts","Write full name and story","Screenshot the chat"],c:0},
    {q:"Before making a referral you should:",a:["Get consent and offer choices","Choose one clinic for them","Ask full medical history"],c:0},
    {q:"Boundaries help because they:",a:["Prevent burnout and role drift","Make you uncaring","Stop you from listening"],c:0},
    {q:"A good empathic reflection is:",a:["You‚Äôre overreacting","It sounds like this is hard for you","Calm down"],c:1},
    {q:"If unsure what to do:",a:["Do nothing","Escalate to supervisor/safeguarding lead","Post on social media"],c:1},
    {q:"A small next step might be:",a:["Plan their whole life","Agree they contact support tomorrow","End abruptly"],c:1},
    {q:"Which is appropriate to log?",a:["Date + concern + action taken","Full name and address","Screenshots"],c:0},
    {q:"Cultural sensitivity includes:",a:["Respecting beliefs & language","Assuming everyone thinks alike","Correcting their culture"],c:0},
    {q:"When a child may be at risk, you should:",a:["Keep it secret","Follow safeguarding protocol and escalate","Handle it alone"],c:1},
    {q:"During listening, silence is:",a:["Useful to give space","A sign you‚Äôre failing","To be avoided"],c:0},
    {q:"Consent in referrals means:",a:["Acting without telling them","Getting informed permission","Telling them they must accept"],c:1}
  ];

  const candName = $('candName');
  const candAge = $('candAge');
  const candLocation = $('candLocation');
  const candRole = $('candRole');
  const candNgo = $('candNgo');
  const candWhatsApp = $('candWhatsApp');

  function loadCandidate(){
    const data = getJSON(KEY_CANDIDATE, {name:'',age:'',location:'',role:'',ngo:'',whatsapp:''});
    candName.value = data.name || '';
    candAge.value = data.age || '';
    candLocation.value = data.location || '';
    candRole.value = data.role || '';
    candNgo.value = data.ngo || '';
    candWhatsApp.value = data.whatsapp || '';
  }
  function saveCandidate(){
    const data = {
      name:(candName.value||'').trim(),
      age:(candAge.value||'').trim(),
      location:(candLocation.value||'').trim(),
      role:(candRole.value||'').trim(),
      ngo:(candNgo.value||'').trim(),
      whatsapp:(candWhatsApp.value||'').trim()
    };
    setJSON(KEY_CANDIDATE, data);
    return data;
  }
  function candidateComplete(){
    const d = saveCandidate();
    if(!d.name) return false;
    const a = parseInt(d.age,10);
    if(!Number.isFinite(a) || a < 10) return false;
    if(!d.location || !d.role || !d.ngo || !d.whatsapp) return false;
    return true;
  }

  function updateAttemptInfo(){
    $('attemptInfo').textContent = `${attemptsThisMonth()} / 2`;
  }

  function updateStartQuizState(){
    const lessonsDone = (parseInt(localStorage.getItem(KEY_LESSON_PROGRESS)||'0',10) >= totalLessons);
    const infoOk = candidateComplete();
    const attemptsOk = canTakeQuiz();
    $('startQuiz').disabled = !(lessonsDone && infoOk && attemptsOk);
    updateAttemptInfo();
  }

  ['input','change'].forEach(evt=>{
    [candName,candAge,candLocation,candRole,candNgo,candWhatsApp].forEach(el=>{
      el.addEventListener(evt, updateStartQuizState);
    });
  });

  function renderQuiz(){
    $('quizForm').innerHTML = QUESTIONS.map((Q,i)=>`
      <fieldset class="q">
        <legend>Q${i+1}. ${Q.q}</legend>
        ${Q.a.map((opt,j)=>`<label><input type="radio" name="q${i}" value="${j}" required> ${opt}</label>`).join('')}
      </fieldset>
    `).join('');
  }

  function fmt(sec){
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }

  let timerId = null;
  function remainingSeconds(){
    const started = parseInt(localStorage.getItem(KEY_TIMER_START)||'0',10);
    if(!started) return QUIZ_SECONDS;
    const elapsed = Math.floor((Date.now()-started)/1000);
    return Math.max(0, QUIZ_SECONDS - elapsed);
  }

  function tick(){
    const r = remainingSeconds();
    $('timeLeft').textContent = fmt(r);
    if(r <= 0){
      clearInterval(timerId);
      gradeQuiz(true);
    }
  }

  function startTimer(){
    localStorage.setItem(KEY_TIMER_START, String(Date.now()));
    tick();
    timerId = setInterval(tick, 1000);
  }

  function resetTimer(){
    clearInterval(timerId);
    localStorage.removeItem(KEY_TIMER_START);
    $('timeLeft').textContent = fmt(QUIZ_SECONDS);
  }

  function lockOutIfNeeded(){
    if(!canTakeQuiz()){
      $('quizResult').style.display = 'block';
      $('quizResult').className = 'result bad';
      $('quizResult').textContent = '‚ö† You have used your 2 attempts for this month. Please try again next month.';
    }
  }

  $('startQuiz').addEventListener('click', async () => {
    // hard guard
    if(!canTakeQuiz()){ lockOutIfNeeded(); return; }
    if(!candidateComplete()){
      alert('Please complete your volunteer details first.');
      return;
    }

    // record attempt (counts even if they fail)
    const used = recordAttempt();
    updateAttemptInfo();

    // log attempt start
    const c = saveCandidate();
    postToGas({ auth: BEARER, type:'training_attempt_start', uid:getUid(), month:monthKey(), attempt:used, candidate:c, ts:new Date().toISOString() });

    // UI
    $('startQuiz').style.display = 'none';
    $('resetQuiz').style.display = 'inline-flex';
    $('quizForm').style.display = 'block';
    $('quizBtns').style.display = 'flex';

    renderQuiz();
    resetTimer();
    startTimer();

    try{ window.plausible && window.plausible('TrainingQuizStarted'); }catch(e){}
  });

  $('resetQuiz').addEventListener('click', () => {
    $('quizForm').reset();
    $('quizResult').style.display = 'none';
    $('postPass').style.display = 'none';
    $('quizForm').style.display = 'none';
    $('quizBtns').style.display = 'none';
    $('startQuiz').style.display = 'inline-flex';
    $('resetQuiz').style.display = 'none';
    resetTimer();
    updateStartQuizState();
  });

  $('submitQuiz').addEventListener('click', () => gradeQuiz(false));

  async function gradeQuiz(timedOut){
    if($('quizForm').style.display === 'none') return;

    if(!timedOut && !$('quizForm').checkValidity()){
      $('quizForm').reportValidity();
      return;
    }

    clearInterval(timerId);

    let correct = 0;
    QUESTIONS.forEach((Q,i)=>{
      const ch = document.querySelector(`input[name=q${i}]:checked`);
      if(ch && parseInt(ch.value,10) === Q.c) correct++;
    });

    const pct = correct / QUESTIONS.length;
    const pass = pct >= PASS_MARK;
    const scorePct = Math.round(pct*100);

    setJSON(KEY_TRAINING, { pct, date: new Date().toISOString() });

    // log pass/fail to sheet
    const candidate = saveCandidate();
    postToGas({
      auth: BEARER,
      type: pass ? 'training_pass' : 'training_fail',
      uid: getUid(),
      month: monthKey(),
      score: scorePct,
      timedOut: !!timedOut,
      candidate,
      ts: new Date().toISOString()
    });

    $('quizResult').style.display = 'block';
    $('quizResult').className = 'result ' + (pass ? 'good' : 'bad');

    if(pass){
      awardBadge('volunteer_trained');
      addPoints(BONUS);
      $('quizResult').textContent = `‚úÖ You scored ${correct}/${QUESTIONS.length} (${scorePct}%). You passed!`;

      // show certificate block
      $('postPass').style.display = 'block';
      $('certName').value = $('certName').value || candidate.name || '';
    }else{
      const used = attemptsThisMonth();
      const remaining = Math.max(0, 2-used);
      $('postPass').style.display = 'none';

      let msg = `‚ùå You scored ${correct}/${QUESTIONS.length} (${scorePct}%). Try again.`;
      if(remaining === 0){
        msg += ' You have reached your 2 attempts for this month. Please try again next month.';
      }
      $('quizResult').textContent = msg;
      lockOutIfNeeded();
    }

    // refresh top pills (XP/badge)
    refreshTopPills(parseInt(localStorage.getItem(KEY_LESSON_PROGRESS)||'0',10), totalLessons);
  }

  function generateCertId(){
    const t=new Date();
    const y=t.getFullYear();
    const m=String(t.getMonth()+1).padStart(2,'0');
    const d=String(t.getDate()).padStart(2,'0');
    const rand=Math.random().toString(36).slice(-4).toUpperCase();
    return `MC-CERT-${y}${m}${d}-${rand}`;
  }

  $('makeCert').addEventListener('click', async () => {
    const name = ($('certName').value || '').trim();
    if(!name){ alert('Enter your name for the certificate.'); return; }

    const t = getJSON(KEY_TRAINING, {pct:1, date:new Date().toISOString()});
    const score = Math.round(t.pct*100);
    const dateIso = t.date || new Date().toISOString();
    const certId = generateCertId();

    // Certificate URL
    const url = `certificate.html?name=${encodeURIComponent(name)}&score=${score}&date=${encodeURIComponent(dateIso)}&cert_id=${encodeURIComponent(certId)}`;

    $('certHint').style.display = 'block';
    $('certHint').innerHTML = `‚úÖ Your certificate is ready: <a class="btn btn-ghost" target="_blank" rel="noopener" href="${url}">Open Certificate</a>`;

    // log certificate issue (sheet)
    const candidate = saveCandidate();
    postToGas({
      auth: BEARER,
      type:'certificate_issue',
      uid:getUid(),
      cert_id: certId,
      name,
      score,
      date: dateIso,
      candidate,
      ts: new Date().toISOString()
    });

    try{ window.plausible && window.plausible('VolunteerCertificateIssued',{props:{score}}); }catch(e){}
  });

  // If lessons already completed, show quiz immediately
  if(completedLessons >= totalLessons){
    $('quizCard').style.display = 'block';
    $('stickyNav').style.display = 'none';
  }

  loadCandidate();
  updateStartQuizState();
  refreshTopPills(completedLessons, totalLessons);

  try{ window.plausible && window.plausible('TrainingHubViewed'); }catch(e){}
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SpeakOut MindCheck ‚Äî Certificate</title>
  <link rel="icon" href="favicon.png"/>
  <link rel="stylesheet" href="mc-theme.css"/>
  <meta name="theme-color" content="#22c55e"/>

  <style>
    body {
      background:#e5f7ed;
    }
    .cert-wrap {
      max-width:1100px;
      margin:24px auto 16px;
      padding:0 10px;
    }
    .cert-main {
      background:#ffffff;
      border-radius:22px;
      border:4px solid #22c55e;
      box-shadow:0 12px 30px rgba(15,23,42,.12);
      padding:28px 32px;
      text-align:center;
      position:relative;
    }
    /* subtle inner frame */
    .cert-main::before {
      content:"";
      position:absolute;
      inset:14px;
      border:1px solid #c4e9d3;
      border-radius:18px;
      pointer-events:none;
    }
    .cert-inner {
      position:relative;
      z-index:1;
    }

    .cert-top {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:10px;
    }
    .cert-logo {
      width:140px;
      height:80px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .cert-brand {
      text-align:right;
      font-size:.9rem;
      color:#064e3b;
    }
    .cert-brand b {
      display:block;
      font-size:1rem;
    }

    .seal {
      font-size:52px;
      margin-top:4px;
    }
    .cert-title {
      font-size:1.7rem;
      font-weight:800;
      margin:.35rem 0 .15rem;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:#062436;
    }
    .cert-sub {
      font-size:.95rem;
      color:#64748b;
      margin-bottom:18px;
    }
    .muted { color:#64748b; }

    .name-label {
      font-size:.95rem;
      text-transform:uppercase;
      letter-spacing:.2em;
      color:#6b7280;
      margin-top:10px;
    }
    .name {
      font-weight:900;
      font-size:1.5rem;
      margin:6px 0 4px;
      color:#022c22;
    }
    .body-text {
      margin-top:4px;
      margin-bottom:16px;
      font-size:.98rem;
      color:#334155;
    }

    .meta-row {
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:12px;
      margin:10px 0 4px;
      font-size:.9rem;
      color:#0f172a;
    }
    .meta-pill {
      border-radius:999px;
      border:1px solid #cbd5e1;
      padding:4px 10px;
      background:#f8fafc;
    }

    .who-footnote {
      font-size:.8rem;
      color:#94a3b8;
      margin-top:6px;
    }

    .sig-row {
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:flex-end;
      gap:16px;
      margin-top:24px;
    }
    .sig-block {
      text-align:left;
    }
    .sig-image {
      max-width:200px;
      height:auto;
      display:block;
      margin:0 0 4px;
    }
    .sig-name {
      font-weight:800;
      color:#0f172a;
    }
    .sig-title {
      font-size:.85rem;
      color:#64748b;
    }
    .sig-label {
      font-size:.8rem;
      color:#9ca3af;
      margin-top:2px;
    }

    .date-block {
      text-align:right;
      font-size:.9rem;
      color:#0f172a;
    }

    .cert-id {
      margin-top:10px;
      font-size:.9rem;
      color:#0f172a;
    }
    .cert-id-code {
      font-family:ui-monospace,Consolas,monospace;
      background:#f1f5f9;
      border-radius:999px;
      padding:3px 8px;
      border:1px solid #cbd5e1;
    }

    .toolbar {
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      margin-top:14px;
    }

    @media (max-width:768px) {
      .cert-main {
        padding:20px 16px;
      }
      .cert-top {
        flex-direction:column;
        align-items:flex-start;
      }
      .cert-brand {
        text-align:left;
      }
      .sig-row {
        flex-direction:column;
        align-items:flex-start;
      }
    }

    @media print {
      body {
        background:#ffffff;
      }
      .no-print {
        display:none !important;
      }
      @page {
        size: A4 landscape;
        margin:15mm;
      }
      .cert-wrap {
        max-width:none;
        margin:0;
        padding:0;
      }
      .cert-main {
        box-shadow:none;
        border-width:3px;
      }
    }
  </style>

  <!-- Plausible analytics (optional event) -->
  <script defer data-domain="speakoutmentalhealth.github.io" src="https://plausible.io/js/script.js"></script>
  <script>
    (function(){
      try { window.plausible && window.plausible('CertificateViewed'); } catch(e){}
    })();
  </script>
</head>
<body>
  <header class="no-print">üß† SpeakOut MindCheck Nigeria</header>

  <main class="cert-wrap">
    <div class="cert-main">
      <div class="cert-inner">

        <div class="cert-top">
          <!-- Logo -->
          <div class="cert-logo">
            <img src="icon/logo.png" 
                 style="max-width:100%;max-height:100%;border-radius:16px;"/>
          </div>

          <div class="cert-brand">
            <b>SpeakOut Mental Health Outreach</b>
            MindCheck Volunteer Training Programme<br/>
            Nigeria (Abuja ‚Ä¢ Keffi ‚Ä¢ Owerri)
          </div>
        </div>

        <div class="seal">üèÖ</div>
        <div class="cert-title">Certificate of Volunteer Training</div>
        <p class="cert-sub">
          This certificate recognises successful completion of community mental-health volunteer training,
          aligned with WHO-style community support and referral principles.
        </p>

        <p class="name-label">Awarded to</p>
        <p id="cName" class="name">‚Äî</p>
        <p class="body-text">
          has completed the SpeakOut MindCheck volunteer training modules on safe listening, red-flag
          recognition, ethical referral, privacy-first logging, and cultural sensitivity / self-care.
        </p>

        <div class="meta-row">
          <span class="meta-pill">
            <b>Score:</b> <span id="cScore">‚Äî</span>%
          </span>
          <span class="meta-pill">
            <b>Date:</b> <span id="cDate">‚Äî</span>
          </span>
        </div>

        <p class="who-footnote">
          Monitoring and quality aligned with WHO Comprehensive Mental Health Action Plan 2013‚Äì2030
          (community support, detection, referral, and follow-up).
        </p>

        <div class="sig-row">
          <div class="sig-block">
            <!-- Signature image above name -->
            <img src="icon/signature.png"  class="sig-image"/>
            <div class="sig-name">Offorka Jerry</div>
            <div class="sig-title">Founder / Executive Director, SpeakOut Mental Health Outreach</div>
            <div class="sig-label">Authorised signatory</div>
          </div>

          <div class="date-block">
            <div><b>Issued:</b> <span id="cDate2">‚Äî</span></div>
            <div class="cert-id">
              <span>Certificate ID:</span>
              <span id="cId" class="cert-id-code">‚Äî</span>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Actions (not printed) -->
    <div class="toolbar no-print">
      <button class="btn btn-primary" onclick="window.print()">Download / Print PDF</button>
      <a class="btn btn-ghost" href="training-hub.html">‚Üê Back to Training</a>
      <a class="btn btn-ghost" href="index.html">Home</a>
    </div>

    <div class="no-print" style="margin-top:10px;text-align:center;font-size:.9rem;color:#4b5563;">
      To verify this certificate,
      <a id="verifyLink" href="verify.html" target="_blank" rel="noopener">verify here</a>.
    </div>
  </main>

  <footer class="no-print" style="margin-top:16px;">
    üîí <a href="privacy.html">Privacy</a> ‚Ä¢
    üìÑ <a href="terms.html">Terms</a> ‚Ä¢
    üè• <a href="resources.html">Clinics & Resources</a> ‚Ä¢
    ‚úâÔ∏è <a href="mailto:speaaakout@gmail.com">speaaakout@gmail.com</a>
  </footer>

  <script>
    // -------- Shared keys (match index/training) --------
    const KEY_TRAINING = 'mc_training';
    const KEY_UID      = 'mc_uid';

    // Create / get browser UID (same logic as MindCheck)
    function getUID() {
      let uid = localStorage.getItem(KEY_UID);
      if (!uid) {
        try { uid = crypto.randomUUID(); }
        catch { uid = 'mc_' + Math.random().toString(36).slice(2); }
        localStorage.setItem(KEY_UID, uid);
      }
      return uid;
    }
    const UID = getUID();

    // Build a deterministic certificate ID
    function buildCertId(dateIso, uid) {
      const d = dateIso ? new Date(dateIso) : new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      const tail = (uid || '').replace(/[^A-Za-z0-9]/g,'').slice(-6).toUpperCase() || 'VOL001';
      return `MC-CERT-${y}${m}${day}-${tail}`;
    }

    // Parse URL params
    const params = new URLSearchParams(location.search);
    const nameParam  = params.get('name') || '';
    const scoreParam = params.get('score') || '';
    const dateParam  = params.get('date') || '';

    // Load from localStorage if needed
    let training = null;
    try { training = JSON.parse(localStorage.getItem(KEY_TRAINING) || '{}'); }
    catch(e){ training = {}; }

    const name   = nameParam || 'Volunteer';
    const score  = scoreParam || (training.pct ? Math.round(training.pct * 100) : '100');
    const dateISO = dateParam ? decodeURIComponent(dateParam) : (training.date || new Date().toISOString());
    const dateObj = new Date(dateISO);

    const dateStr = dateObj.toLocaleDateString();

    document.getElementById('cName').textContent  = name;
    document.getElementById('cScore').textContent = score;
    document.getElementById('cDate').textContent  = dateStr;
    document.getElementById('cDate2').textContent = dateStr;

    // Compute Certificate ID
    const certId = buildCertId(dateISO, UID);
    document.getElementById('cId').textContent = certId;

    // Update verify link to carry the certId
    const vLink = document.getElementById('verifyLink');
    if (vLink) {
      vLink.href = `verify.html?certId=${encodeURIComponent(certId)}`;
    }

    // -------- Register certificate in backend (for verification) --------
    (function registerCertificate(){
      try {
        const payload = {
          type: 'register_cert',
          cert_id: certId,
          name: name,
          score: score,
          date_iso: dateISO,
          uid: UID,
          app_version: 'v1.0.0'
        };

        fetch('https://script.google.com/macros/s/AKfycbwbTvjd_4QXeFUmtBZxK1aldG0CtGSEELiP-koRFO-0G-IqctT32syjnSF1-Crl5tQ00A/exec?auth=speakout123', {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain' }, // simple (no CORS preflight)
          body: JSON.stringify(payload)
        })
        .then(r => r.text())
        .then(t => { console.log('Cert register response:', t); })
        .catch(e => console.warn('Cert register failed:', e));
      } catch(e) {
        console.warn('Cert register block error:', e);
      }
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Privacy-friendly analytics (Plausible) -->
  <script defer data-domain="speakoutmentalhealth.github.io" src="https://plausible.io/js/script.js"></script>

  <!-- PWA manifest + theme -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#22c55e">

  <!-- Icons -->
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="favicon.png">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SpeakOut MindCheck ğŸ’š</title>

  <style>
    :root { --green:#22c55e; --greenDark:#16a34a; --ink:#062436; --bg:#f5fdf8; --card:#ffffff; }
    body { font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--ink); text-align:center; margin:0; padding:0; }
    header{background:var(--green);color:#fff;padding:1.2rem;font-size:1.6rem;font-weight:800;}
    p{margin:.75rem 0;}
    .btn{border:none;padding:12px 16px;border-radius:14px;font-size:1rem;cursor:pointer;transition:.15s;}
    .btn-primary{background:var(--green);color:#fff;box-shadow:0 6px 20px rgba(34,197,94,.3);}
    .btn-primary:hover{background:var(--greenDark);}
    .btn-ghost{background:#fff;border:1px solid #e5e7eb;}
    section{display:none;padding:16px;animation:fadeIn .25s ease-in-out;}
    section.active{display:block;}
    .twrap{display:flex;justify-content:center;flex-wrap:wrap;gap:12px;margin-top:10px;}
    .tbtn{background:var(--green);color:#fff;padding:10px 18px;border-radius:10px;font-weight:700;transition:.2s ease;display:inline-flex;align-items:center;gap:6px;cursor:pointer;box-shadow:0 4px 15px rgba(34,197,94,.25);}
    .tbtn:hover{background:var(--greenDark);transform:translateY(-1px) scale(1.03);}
    .tbtn.live{animation:pulse 2s infinite;}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(34,197,94,.4)}50%{box-shadow:0 0 0 10px rgba(34,197,94,0)}}
    .tbtn.soon{background:linear-gradient(145deg,#a7f3d0,#6ee7b7);color:#064e3b;cursor:default;position:relative;}
    .tbtn.soon::after{content:attr(data-tooltip);position:absolute;bottom:125%;left:50%;transform:translateX(-50%);background:#062436;color:#fff;padding:6px 10px;border-radius:6px;font-size:.8rem;white-space:nowrap;opacity:0;transition:opacity .3s;box-shadow:0 3px 8px rgba(0,0,0,.15);}
    .tbtn.soon:hover::after{opacity:1;}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-top:16px;text-align:left;}
    .card{background:var(--card);border:1px solid #eef2f7;border-radius:14px;padding:16px;box-shadow:0 6px 18px rgba(2,23,34,.05);cursor:pointer;transition:transform .12s;}
    .card:hover{transform:translateY(-2px);}
    .card .big{font-size:28px;line-height:1;}
    .card h3{margin:.4rem 0 .25rem;font-size:1.05rem;}
    .card p{margin:.2rem 0 0;color:#52606d;font-size:.92rem;}
    .stats{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:10px auto;max-width:960px;}
    .pill{background:#fff;border:1px solid #e5e7eb;border-radius:999px;padding:8px 12px;font-weight:600;}
    .crisis{max-width:680px;margin:12px auto;padding:12px;border:1px solid #fecaca;background:#fff1f2;border-radius:12px;color:#7f1d1d;}
    .crisis .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px;}
    .badge-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:14px auto;max-width:900px;}
    .badge{border:1px solid #e8eef5;border-radius:12px;background:#fff;text-align:left;padding:12px;}
    .badge.locked{opacity:.55;}
    .badge .name{font-weight:700;margin:.2rem 0;}
    .badge .desc{font-size:.9rem;color:#52606d;margin:.1rem 0 .3rem;}
    .badge .status{font-size:.85rem;color:#0b5;}
    .award-list{max-width:900px;margin:14px auto;display:grid;gap:12px;}
    .award{border:1px solid #e8eef5;border-radius:12px;background:#fff;text-align:left;padding:12px;}
    .award .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .award .id{font-family:ui-monospace,Consolas,monospace;background:#f6f7f9;border:1px solid #e8eef5;border-radius:6px;padding:4px 6px;}
    iframe{width:100%;height:800px;border:0;border-radius:12px;background:#fff;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
    footer{margin:28px 0 40px;font-size:.95rem;opacity:.9;} footer a{color:inherit;}
    .toolbar{display:flex;gap:10px;justify-content:center;margin-top:10px;flex-wrap:wrap;}
    #savedTipsList li { margin: 6px 0; } #savedTipsList small { color:#64748b; }
  </style>
</head>
<body>
  <header>ğŸ§  SpeakOut MindCheck Nigeria</header>
  <p>Check your mental health privately, safely, and in your preferred language.</p>
  <button id="startBtn" class="btn btn-primary">Start Now</button>
<script>
/* Failsafe: wire Start Now even if other JS fails */
(function() {
  // Show helper (minimal, in case the main show() isnâ€™t defined yet)
  function minimalShow(section) {
    var ids = ["langSection","homeSection","moodSection","formContainer","tipsSection","helpSection","badgesSection"];
    ids.forEach(function(id){ var el=document.getElementById(id); if(el) el.classList.remove('active'); });
    if (section) { section.classList.add('active'); section.scrollIntoView({behavior:'smooth'}); }
  }

  function goToLang() {
    var startBtn = document.getElementById('startBtn');
    var lang = document.getElementById('langSection');
    if (startBtn) startBtn.style.display = 'none';
    if (typeof window.show === 'function') {
      try { window.show(lang); } catch(e) { console.warn('show() failed, using minimalShow', e); minimalShow(lang); }
    } else {
      minimalShow(lang);
    }
  }

  // Bind as early as possible
  document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('startBtn');
    if (btn) {
      btn.addEventListener('click', function(ev){ ev.preventDefault(); goToLang(); }, { once:true });
    }
  });

  // Last-resort inline onclick (works even if earlier JS never ran)
  var btnEl = document.getElementById('startBtn');
  if (btnEl && !btnEl.getAttribute('data-onclick-patched')) {
    btnEl.setAttribute('onclick', '(' + goToLang.toString() + ')();');
    btnEl.setAttribute('data-onclick-patched','1');
  }
})();
</script>

<!-- Simple runtime error reporter so we can see the real blocker -->
<script>
window.addEventListener('error', function(ev){
  console.error('JS Error:', ev.message, 'at', ev.filename+':'+ev.lineno+':'+ev.colno);
  // Optional: one-time alert to surface the exact error line
  if (!window._mcAlerted) {
    window._mcAlerted = true;
    alert('A script error stopped the app:\n' + ev.message + '\nCheck DevTools Console for details.');
  }
});
</script>

  <!-- Language -->
  <section id="langSection">
    <p style="font-weight:700;">ğŸŒ Choose your language:</p>
    <div class="twrap">
      <button class="tbtn live" data-lang="en">English</button>
      <span class="tbtn soon" data-tooltip="Launching soon in Hausa">ğŸ•“ Hausa â€” Coming Soon</span>
      <span class="tbtn soon" data-tooltip="Launching soon in Yoruba">ğŸ•“ Yoruba â€” Coming Soon</span>
      <span class="tbtn soon" data-tooltip="Launching soon in Igbo">ğŸ•“ Igbo â€” Coming Soon</span>
      <span class="tbtn soon" data-tooltip="Launching soon in French">ğŸ•“ French â€” Coming Soon</span>
    </div>
  </section>

  <!-- Home + Stats -->
  <section id="homeSection">
    <h2>Welcome to MindCheck ğŸŒ¿</h2>
    <p id="statsText" style="color:#334155;font-weight:500;margin-bottom:4px;"></p>
    <div class="stats">
      <span class="pill">Points: <span id="pointsPill">0</span></span>
      <span class="pill">Streak: <span id="streakPill">0</span> day(s)</span>
      <span class="pill">Tips done (7d): <span id="tipsDonePill">0</span></span>
      <span class="pill">Awards: <span id="awardsPill">0</span> pending</span>
    </div>
    <div class="grid">
      <div class="card" id="goMood"><div class="big">ğŸ˜Š</div><h3>Check Your Mood</h3><p>Earn points once daily (+10). 20-day streak wins â‚¦1000.</p></div>
      <div class="card" id="goScreenings"><div class="big">ğŸ§ </div><h3>Mental Health Screenings</h3><p>WHO-5, PHQ-9, GAD-7, and PSS-10.</p></div>
      <a class="card" id="goTips" href="#"><div class="big">ğŸŒ¿</div><h3>Wellness Tips</h3><p>Simple habits for calm and focus.</p></a>
      <a class="card" id="goHelp" href="#"><div class="big">ğŸ“</div><h3>Get Help</h3><p>Find mental-health support nearby.</p></a>
      <div class="card" id="goBadges"><div class="big">ğŸ…</div><h3>Badges & Awards</h3><p>See unlocked badges & claim awards.</p></div>
    </div>
  </section>

  <!-- Mood Check-in -->
  <section id="moodSection">
    <h2>How are you feeling today?</h2>
    <div class="mood-row">
      <button class="mood" data-val="4">ğŸ˜„<br><span class="mood-label">Very Happy</span></button>
      <button class="mood" data-val="3">ğŸ˜Š<br><span class="mood-label">Happy</span></button>
      <button class="mood" data-val="2">ğŸ˜<br><span class="mood-label">Okay</span></button>
      <button class="mood" data-val="1">ğŸ˜<br><span class="mood-label">Sad</span></button>
      <button class="mood" data-val="0">ğŸ˜¢<br><span class="mood-label">Very Sad</span></button>
    </div>

    <div id="crisisBanner" class="crisis" style="display:none;">
      <b>We care about you.</b> It looks like things have been tough for a few days.
      <div class="row">
        <a class="btn btn-primary" href="tel:112">Call 112 (Emergency)</a>
        <a class="btn btn-ghost" href="tel:+2348118103510">SpeakOut Helpline</a>
        <a class="btn btn-ghost" href="https://wa.me/2348118103510" target="_blank" rel="noopener">WhatsApp a volunteer</a>
        <button id="dismissCrisis" class="btn btn-ghost">Dismiss for today</button>
      </div>
    </div>

    <div id="moodResult" class="result" style="display:none;"></div>
    <div class="toolbar"><button id="moodBackHome" class="btn btn-ghost">Back to Home</button></div>
  </section>

  <!-- Screenings form -->
  <section id="formContainer">
    <iframe id="formFrame" src="" title="SpeakOut MindCheck form"></iframe>
    <div class="toolbar"><button id="formBackHome" class="btn btn-ghost">Back to Home</button></div>
  </section>

  <!-- Wellness Tips -->
  <section id="tipsSection">
    <h2>Wellness Tips ğŸŒ¿</h2>
    <p id="tipsGreeting" style="font-weight:600;color:#334155;margin:6px 0;"></p>
    <div class="toolbar">
      <button class="btn btn-ghost tip-filter" data-filter="all">All</button>
      <button class="btn btn-ghost tip-filter" data-filter="calm">Calm</button>
      <button class="btn btn-ghost tip-filter" data-filter="anxious">Anxious</button>
      <button class="btn btn-ghost tip-filter" data-filter="low">Low</button>
      <button class="btn btn-ghost tip-filter" data-filter="neutral">Neutral</button>
      <button class="btn btn-ghost tip-filter" data-filter="positive">Positive</button>
    </div>

    <div class="card" id="tipCard" style="max-width:680px;margin:14px auto;text-align:left;">
      <div class="big">ğŸŒ±</div>
      <h3 id="tipText" style="margin:.5rem 0;"></h3>
      <p id="tipNote" style="color:#52606d;margin:0;"></p>
      <div class="toolbar" style="justify-content:flex-start;margin-top:12px;">
        <button id="tipDoneBtn" class="btn btn-primary">Done âœ…</button>
        <button id="tipSaveBtn" class="btn btn-ghost">Save tip â­</button>
      </div>
      <p id="tipStatus" style="color:#0b5;font-weight:600;display:none;margin-top:8px;"></p>
    </div>

    <details style="max-width:680px;margin:10px auto;text-align:left;background:#fff;border:1px solid #eef2f7;border-radius:12px;padding:10px;">
      <summary style="cursor:pointer;font-weight:700;">â­ Saved tips</summary>
      <ul id="savedTipsList" style="padding-left:18px;margin-top:8px;"></ul>
    </details>

    <div class="toolbar">
      <button id="nextTip" class="btn btn-primary">Show another tip</button>
      <button id="tipsBackHome" class="btn btn-ghost">Back to Home</button>
    </div>
  </section>

  <!-- Get Help -->
  <section id="helpSection">
    <h2>Get Help ğŸ“</h2>
    <p style="color:#334155">If you're in immediate danger or feel unsafe, contact your local emergency number.</p>
    <div class="grid" style="max-width:820px;margin:0 auto;">
      <a class="card" href="tel:112"><div class="big">ğŸš‘</div><h3>Emergency Services</h3><p>Call 112 (or your country emergency number) for urgent help.</p></a>
      <a class="card" href="tel:+2348118103510"><div class="big">ğŸ“</div><h3>SpeakOut Helpline</h3><p>Call us for support and referral options.</p></a>
      <a class="card" href="https://wa.me/2348118103510" target="_blank" rel="noopener"><div class="big">ğŸ’¬</div><h3>WhatsApp</h3><p>Chat with a SpeakOut volunteer.</p></a>
      <a class="card" href="/MindCheck/resources.html"><div class="big">ğŸ“</div><h3>Clinics & Resources</h3><p>Find mental-health services near you.</p></a>
    </div>
    <div class="toolbar"><button id="helpBackHome" class="btn btn-ghost">Back to Home</button></div>
  </section>

  <!-- Badges & Awards -->
  <section id="badgesSection">
    <h2>Badges & Awards ğŸ…</h2>
    <p style="color:#334155">Daily mood check-ins earn points; 20-day streak wins â‚¦1000. Claim via WhatsApp with your Award ID.</p>
    <div id="badgesGrid" class="badge-list"></div>
    <h3 style="margin-top:18px;">Your Awards</h3>
    <div id="awardsList" class="award-list"></div>
    <div class="toolbar"><button id="badgesBackHome" class="btn btn-ghost">Back to Home</button></div>
  </section>

  <footer style="margin-top:20px;">
    ğŸ”’ <a href="/MindCheck/privacy.html">Privacy</a> â€¢
    ğŸ“„ <a href="/MindCheck/terms.html">Terms</a> â€¢
    âœ‰ï¸ <a href="mailto:speaaakout@gmail.com">support@speakout.ng</a>
  </footer>

  <script>
    /* ---------- Element refs & navigation ---------- */
    const startBtn=document.getElementById('startBtn');
    const langSection=document.getElementById('langSection');
    const homeSection=document.getElementById('homeSection');
    const moodSection=document.getElementById('moodSection');
    const formContainer=document.getElementById('formContainer');
    const tipsSection=document.getElementById('tipsSection');
    const helpSection=document.getElementById('helpSection');
    const badgesSection=document.getElementById('badgesSection');

    const formFrame=document.getElementById('formFrame');
    const statsText=document.getElementById('statsText');
    const pointsPill=document.getElementById('pointsPill');
    const streakPill=document.getElementById('streakPill');
    const awardsPill=document.getElementById('awardsPill');
    const tipsDonePill=document.getElementById('tipsDonePill');
    const moodResult=document.getElementById('moodResult');

    const tipText=document.getElementById('tipText');
    const tipNote=document.getElementById('tipNote');
    const nextTipBtn=document.getElementById('nextTip');
    const tipsGreeting=document.getElementById('tipsGreeting');
    const tipSaveBtn=document.getElementById('tipSaveBtn');
    const tipDoneBtn=document.getElementById('tipDoneBtn');
    const tipStatus=document.getElementById('tipStatus');
    const savedTipsList=document.getElementById('savedTipsList');

    const badgesGrid=document.getElementById('badgesGrid');
    const awardsList=document.getElementById('awardsList');

    const crisisBanner=document.getElementById('crisisBanner');
    const dismissCrisis=document.getElementById('dismissCrisis');
    const sparkSVG=document.getElementById('moodSpark');

    function show(section){
      [langSection,homeSection,moodSection,formContainer,tipsSection,helpSection,badgesSection].forEach(s=>s.classList.remove('active'));
      section.classList.add('active');
      section.scrollIntoView({behavior:'smooth'});

      if(section===homeSection){ updateStats(); updateHeaderPills(); renderSparkline(); }
      if(section===badgesSection){ renderBadges(); renderAwards(); }
      if(section===tipsSection){ renderSavedTips(); renderTip(); }
    }

    startBtn.onclick=()=>{startBtn.style.display='none';show(langSection);};
    document.querySelectorAll('.tbtn.live').forEach(btn=>{
      btn.onclick=()=>{ localStorage.setItem('mc_lang', btn.dataset.lang || 'en'); show(homeSection); };
    });

    document.getElementById('goMood').onclick=()=>show(moodSection);
    document.getElementById('moodBackHome').onclick=()=>show(homeSection);

    document.getElementById('goScreenings').onclick=()=>{ formFrame.src='https://tally.so/r/w2QbOV'; show(formContainer); };
    document.getElementById('formBackHome').onclick=()=>show(homeSection);

    document.getElementById('goTips').onclick=(e)=>{ e.preventDefault(); currentTipFilter = lastMoodTag(); show(tipsSection); };
    document.getElementById('tipsBackHome').onclick=()=>show(homeSection);

    document.getElementById('goHelp').onclick=(e)=>{e.preventDefault(); show(helpSection);};
    document.getElementById('helpBackHome').onclick=()=>show(homeSection);

    document.getElementById('goBadges').onclick=()=>show(badgesSection);
    document.getElementById('badgesBackHome').onclick=()=>show(homeSection);

    /* ---------- Keys & UID (define ONCE) ---------- */
    const KEY_UID='mc_uid';
    const KEY_POINTS='mc_points';
    const KEY_STREAK='mc_streak';
    const KEY_LAST='mc_lastCheckin';
    const KEY_HISTORY='mc_mood_history';
    const KEY_BADGES='mc_badges';
    const KEY_AWARDS='mc_awards';
    const KEY_TIPS_SAVED='mc_tips_saved';
    const KEY_TIPS_DONE ='mc_tips_done';
    const KEY_CRISIS_DISMISS='mc_crisis_dismiss_date';

    function getUID() {
      let uid = localStorage.getItem(KEY_UID);
      if (!uid) {
        try { uid = crypto.randomUUID(); }
        catch { uid = 'mc_' + Math.random().toString(36).slice(2); }
        localStorage.setItem(KEY_UID, uid);
      }
      return uid;
    }
    const UID = getUID();
    window.MC_UID = UID; // expose if other scripts ever need it

    /* ---------- Helpers ---------- */
    function todayStr(){ const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
    function isoToDate(iso){ return new Date(iso); }
    function getJSON(key, fallback){ try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }catch(e){ return fallback; } }
    function setJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
    const getPoints=()=>parseInt(localStorage.getItem(KEY_POINTS)||'0',10);
    const setPoints=v=>localStorage.setItem(KEY_POINTS, String(v));
    const addPoints=n=>setPoints(getPoints()+n);
    const getStreak=()=>parseInt(localStorage.getItem(KEY_STREAK)||'0',10);
    const setStreak=v=>localStorage.setItem(KEY_STREAK, String(v));
    const getLast=()=>localStorage.getItem(KEY_LAST) || '';
    const setLast=v=>localStorage.setItem(KEY_LAST, v);
    const getBadges=()=>getJSON(KEY_BADGES, []);
    const setBadges=arr=>setJSON(KEY_BADGES, arr);
    function awardBadge(id){ const b=getBadges(); if(!b.includes(id)){ b.push(id); setBadges(b); return true;} return false; }
    const getAwards=()=>getJSON(KEY_AWARDS, []);
    const setAwards=arr=>setJSON(KEY_AWARDS, arr);
    function getSavedTips(){ return getJSON(KEY_TIPS_SAVED, []); }
    function setSavedTips(arr){ setJSON(KEY_TIPS_SAVED, arr); }
    function getDoneTips(){ return getJSON(KEY_TIPS_DONE, []); }
    function setDoneTips(arr){ setJSON(KEY_TIPS_DONE, arr); }

    /* ---------- Config ---------- */
    const AWARD_AMOUNT_NAIRA = 1000;
    const WHATSAPP_NUMBER = '2348118103510';

    /* ---------- Mood check-in (daily) ---------- */
    document.querySelectorAll('.mood').forEach(btn=>{
      btn.onclick=()=>handleCheckin(parseInt(btn.dataset.val,10));
    });

    async function handleCheckin(moodValue){
      const today = todayStr();
      const last = getLast();
      if(last===today){
        moodResult.style.display='block';
        moodResult.innerHTML=`<p>âœ… You already checked in today. Come back tomorrow!</p>`;
        return;
      }

      addPoints(10);
      setLast(today);
      const yesterdayStr = (()=>{ const d=new Date(); d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); })();
      if(last===yesterdayStr){ setStreak(getStreak()+1); } else { setStreak(1); }

      const arr=getJSON(KEY_HISTORY, []);
      arr.push({ ts:new Date().toISOString(), mood_value:moodValue });
      setJSON(KEY_HISTORY, arr);

      const emoji=['ğŸ˜¢','ğŸ˜','ğŸ˜','ğŸ˜Š','ğŸ˜„'][moodValue] || 'ğŸ˜';
      let tip="Take a deep breath for 60 seconds.";
      if(moodValue>=3) tip="Great mood! Share a smile today ğŸŒ».";
      if(moodValue===2) tip="Stretch or walk a little to refresh.";
      if(moodValue<=1) tip="Youâ€™re not alone â€” breathe and reach out if you need help.";

      const newly=[];
      if(awardBadge('first_checkin')) newly.push('First Check-in');
      if(getStreak()>=3 && awardBadge('streak_3')) newly.push('3-Day Streak');
      if(getStreak()>=7 && awardBadge('streak_7')) newly.push('7-Day Streak');
      const pts=getPoints();
      if(pts>=100 && awardBadge('points_100')) newly.push('100 Points');
      if(pts>=300 && awardBadge('points_300')) newly.push('300 Points');

      let awardHTML=''; let created=null;
      const streak = getStreak();
      if(streak>0 && streak%20===0){
        created = createStreakAwardIfNew(streak);
        if(created){
          awardHTML = `
            <p style="font-size:1.05rem;">ğŸ <b>Congratulations!</b> Youâ€™ve won
            <b>â‚¦${AWARD_AMOUNT_NAIRA.toLocaleString()}</b> for your <b>${streak}-day streak</b>.<br/>
            Use your Award ID to claim on WhatsApp.</p>
            <p>Award ID: <span class="id" style="font-family:ui-monospace,Consolas,monospace;">${created.id}</span></p>
            <p><a class="btn btn-primary" href="${whatsAppClaimLink(created)}" target="_blank" rel="noopener">Claim via WhatsApp</a></p>
          `;
        }
      }

      moodResult.style.display='block';
      moodResult.innerHTML=`
        <p>ğŸ‰ Thanks for checking in ${emoji} â€” you earned <b>+10 points</b>.</p>
        <p>Streak: <b>${getStreak()}</b> day(s) â€¢ Points: <b>${getPoints()}</b></p>
        <p><b>Tip:</b> ${tip}</p>
        ${newly.length ? `<p>ğŸ… New badge${newly.length>1?'s':''}: <b>${newly.join(', ')}</b></p>` : ''}
        ${awardHTML}
      `;
      updateHeaderPills();
      maybeShowCrisis();

      // backend log (Google Apps Script)
      try{
        const body = {
          auth: 'speakout123',
          type: 'checkin',
          uid: UID,
          day: todayStr(),
          mood_value: moodValue,
          streak_after: getStreak(),
          points_after: getPoints(),
          lang: localStorage.getItem('mc_lang') || 'en',
          app_version: 'v1.0.0',
          award_issued: !!created,
          award_id: created ? created.id : ''
        };
    <script>
  (async () => {
    try {
      await fetch('https://script.google.com/macros/s/AKfycbwbTvjd_4QXeFUmtBZxK1aldG0CtGSEELiP-koRFO-0G-IqctT32syjnSF1-Crl5tQ00A/exec?auth=speakout123', {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({
          type: 'checkin',
          uid: (typeof UID !== 'undefined' && UID) ? UID : ('mc_' + Math.random().toString(36).slice(2)),
          day: new Date().toISOString().slice(0,10),
          mood_value: 3,
          streak_after: 0,
          points_after: 0,
          lang: localStorage.getItem('mc_lang') || 'en',
          app_version: 'v1.0'
        })
      });
    } catch (e) {
      console.warn('Check-in logging failed:', e);
    }
  })();
</script>


<script>
    function createStreakAwardIfNew(streakCycle){
      const awards = getAwards();
      if (awards.find(a => a.streak_cycle === streakCycle)) return null;
      const today = new Date();
      const y = today.getFullYear();
      const m = String(today.getMonth()+1).padStart(2,'0');
      const d = String(today.getDate()).padStart(2,'0');
      const uidTail = UID.replace(/-/g,'').slice(-6).toUpperCase();
      const id = `MC-${y}${m}${d}-${uidTail}-${streakCycle}`;
      const award = { id, amount: AWARD_AMOUNT_NAIRA, issued_at: today.toISOString(), streak_cycle: streakCycle, uid: UID, claimed:false, claimed_at:null };
      awards.push(award); setAwards(awards); return award;
    }
    function whatsAppClaimLink(a){
      const msg = encodeURIComponent(`Hello SpeakOut,\n\nI want to claim my MindCheck award.\nAward ID: ${a.id}\nAmount: â‚¦${a.amount}\nUID: ${UID}\n\nThank you!`);
      return `https://wa.me/2348118103510?text=${msg}`;
    }

    /* ---------- Home stats ---------- */
    function updateHeaderPills(){
      pointsPill.textContent=getPoints();
      streakPill.textContent=getStreak();
      const pend = getAwards().filter(a=>!a.claimed).length;
      awardsPill.textContent = pend;
      if (tipsDonePill) tipsDonePill.textContent = tipsDoneLast7d();
    }
    function updateStats(){
      const arr=getJSON(KEY_HISTORY, []);
      const now=new Date(); const weekAgo=new Date(now); weekAgo.setDate(now.getDate()-7);
      const weekCount=arr.filter(i=>{ const t=isoToDate(i.ts); return t>=weekAgo && t<=now; }).length;
      statsText.textContent = weekCount>0
        ? `ğŸ“Š Youâ€™ve checked your mood ${weekCount} time${weekCount>1?'s':''} this week.`
        : `ğŸ“Š You havenâ€™t checked your mood this week yet â€” try it now!`;
    }
    function tipsDoneLast7d(){
      const done=getDoneTips(); const now=new Date(); const wk=new Date(now); wk.setDate(now.getDate()-7);
      return done.filter(i=>{const t=new Date(i.done_at); return t>=wk && t<=now;}).length;
    }
    function renderSparkline(){ if(!sparkSVG) return; sparkSVG.innerHTML=''; } // safe no-op (no SVG in DOM)

    /* ---------- Badges & Awards rendering ---------- */
    const BADGE_CATALOG = [
      { id:'first_checkin', name:'First Check-in', desc:'Your first ever mood check.' },
      { id:'streak_3', name:'3-Day Streak', desc:'Checked your mood 3 days in a row.' },
      { id:'streak_7', name:'7-Day Streak', desc:'Checked your mood 7 days in a row.' },
      { id:'points_100', name:'100 Points', desc:'Reached 100 total points.' },
      { id:'points_300', name:'300 Points', desc:'Reached 300 total points.' },
    ];
    function renderBadges(){
      const owned=new Set(getBadges());
      badgesGrid.innerHTML = BADGE_CATALOG.map(b=>{
        const unlocked=owned.has(b.id);
        return `
          <div class="badge ${unlocked?'':'locked'}">
            <div class="name">ğŸ… ${b.name}</div>
            <div class="desc">${b.desc}</div>
            <div class="status">${unlocked ? 'Unlocked âœ…' : 'Locked ğŸ”’'}</div>
          </div>
        `;
      }).join('');
    }
    function renderAwards(){
      const awards = getAwards().sort((a,b)=> new Date(b.issued_at) - new Date(a.issued_at));
      if(!awards.length){
        awardsList.innerHTML = `<div class="award"><p>No awards yet. Keep your streak to win â‚¦${AWARD_AMOUNT_NAIRA.toLocaleString()} every 20 days.</p></div>`;
        return;
      }
      awardsList.innerHTML = awards.map(a=>{
        const when = new Date(a.issued_at).toLocaleString();
        const status = a.claimed ? `Claimed âœ… (${new Date(a.claimed_at).toLocaleString()})` : 'Pending ğŸ””';
        const btns = a.claimed ? '' : `
          <a class="btn btn-primary" href="${whatsAppClaimLink(a)}" target="_blank" rel="noopener">Claim via WhatsApp</a>
          <button class="btn btn-ghost" data-mark="${a.id}">Mark as Claimed</button>
        `;
        return `
          <div class="award">
            <div class="row">
              <div>
                <div><b>â‚¦${a.amount.toLocaleString()}</b> â€¢ Streak: ${a.streak_cycle} days</div>
                <div>ID: <span class="id">${a.id}</span></div>
                <div style="color:#52606d">Issued: ${when} â€¢ ${status}</div>
              </div>
              <div>${btns}</div>
            </div>
          </div>
        `;
      }).join('');
      document.querySelectorAll('[data-mark]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-mark');
          const list = getAwards();
          const idx = list.findIndex(x=>x.id===id);
          if(idx>-1){
            list[idx].claimed = true;
            list[idx].claimed_at = new Date().toISOString();
            setAwards(list);
            renderAwards();
            updateHeaderPills();
            alert('Marked as claimed. Thank you!');
          }
        });
      });
    }

    /* ---------- Tips engine (time-aware + save/done) ---------- */
    const TIPS = [
      { text: "ğŸ§˜â€â™€ï¸ Do the 4-7-8 breathing: inhale 4s, hold 7s, exhale 8s. Repeat 4 cycles.", tags: ["anxious","calm","neutral"], times:["evening","night"] },
      { text: "ğŸš¶â€â™‚ï¸ Take a 10-minute mindful walk. Notice 3 sounds, 3 sights, 3 smells.", tags: ["low","neutral","positive"], times:["morning","afternoon"] },
      { text: "ğŸ““ Write three gratitudes. Keep each to one sentence to make it easy.", tags: ["neutral","low","positive"], times:["evening"] },
      { text: "ğŸ’§ Drink a full glass of water, then stretch neck, shoulders, and back for one minute.", tags: ["low","neutral","all"], times:["morning","afternoon"] },
      { text: "ğŸ“µ Mute non-urgent notifications for 30 minutes and do one tiny task youâ€™ve avoided.", tags: ["anxious","calm","neutral"], times:["afternoon"] },
      { text: "ğŸ¶ Play one uplifting song. Breathe with the rhythm or sing along to release tension.", tags: ["low","neutral","positive"], times:["morning","afternoon","evening"] },
      { text: "ğŸŒ¤ Get 5 minutes of sunlight. Look at the sky and take 5 deep breaths.", tags: ["low","neutral","positive"], times:["morning"] },
      { text: "ğŸ’¬ Send a quick check-in: â€œThinking of you. How are you today?â€", tags: ["anxious","low","positive"], times:["afternoon","evening"] },
      { text: "ğŸ› Before bed, name one thing you did well and one tiny thing to try tomorrow.", tags: ["low","neutral","positive"], times:["evening","night"] },
      { text: "ğŸŒ± Box breathing: inhale 4s, hold 4s, exhale 4s, hold 4s (3â€“4 rounds).", tags: ["anxious","calm","neutral"], times:["any"] }
    ];
    let currentTipFilter='all';
    let currentTipObj=null;

    function lastMoodTag(){
      const arr=getJSON(KEY_HISTORY, []);
      if(!arr.length) return 'all';
      const last=arr[arr.length-1].mood_value;
      if(last<=1) return 'low';
      if(last===2) return 'neutral';
      if(last>=3) return 'positive';
      return 'all';
    }
    function getDaypart(){ const h=new Date().getHours(); if(h>=5&&h<12)return'morning'; if(h>=12&&h<17)return'afternoon'; if(h>=17&&h<21)return'evening'; return'night'; }
    function greetingFor(d){ return d==='morning'?'Good morning! Try this reset ideaâ€¦':d==='afternoon'?'Good afternoon! A quick refreshâ€¦':d==='evening'?'Good evening! Try this wind-down tipâ€¦':'Itâ€™s a quiet time â€” hereâ€™s a gentle tipâ€¦'; }
    function pickTip(filter='all'){
      const day=getDaypart();
      const fitsFilter=t=>filter==='all'||(t.tags||[]).includes(filter);
      const fitsTime=t=>!t.times||t.times.includes('any')||t.times.includes(day);
      const pool=TIPS.filter(fitsFilter);
      const timed=pool.filter(fitsTime);
      const src=timed.length?timed:pool;
      return src[Math.floor(Math.random()*src.length)];
    }
    function renderTip(){
      const day=getDaypart();
      tipsGreeting.textContent=greetingFor(day);
      const fallback={text:"Take a slow deep breath â€” youâ€™ve got this.",tags:["all"]};
      const tip=pickTip(currentTipFilter) || fallback;
      currentTipObj=tip;
      tipText.textContent=tip.text;
      tipNote.textContent=currentTipFilter==='all'?`Suggested for: ${day}`:`Filter: ${currentTipFilter} â€¢ Suggested for: ${day}`;
      tipStatus.style.display='none';
    }
    function renderSavedTips(){
      const saved=getSavedTips();
      if(!saved.length){ savedTipsList.innerHTML='<li><em>No saved tips yet.</em></li>'; return; }
      savedTipsList.innerHTML=saved.slice().reverse().map(t=>`<li>${t.text} <br><small>Saved ${new Date(t.saved_at).toLocaleString()}</small></li>`).join('');
    }
    tipSaveBtn.addEventListener('click', ()=>{
      if(!currentTipObj) return;
      const saved=getSavedTips();
      if(!saved.find(s=>s.text===currentTipObj.text)){
        saved.push({text:currentTipObj.text,saved_at:new Date().toISOString()});
        setSavedTips(saved); renderSavedTips();
      }
      tipStatus.textContent='â­ Saved!'; tipStatus.style.display='block'; updateHeaderPills();
    });
    tipDoneBtn.addEventListener('click', ()=>{
      if(!currentTipObj) return;
      const done=getDoneTips(); done.push({text:currentTipObj.text,done_at:new Date().toISOString()});
      setDoneTips(done); tipStatus.textContent='âœ… Great job â€” marked as done!'; tipStatus.style.display='block'; updateHeaderPills();
    });
    document.querySelectorAll('.tip-filter').forEach(btn=>{
      btn.addEventListener('click', ()=>{ currentTipFilter=btn.dataset.filter||'all'; renderTip(); });
    });
    nextTipBtn.addEventListener('click', renderTip);

    /* ---------- Crisis smart-routing ---------- */
    function verySadStreak3Days(){
      const hist=getJSON(KEY_HISTORY, []);
      if(hist.length<3) return false;
      const days=[]; for(let i=0;i<3;i++){ const d=new Date(); d.setDate(d.getDate()-i); days.push(d.toISOString().slice(0,10)); }
      return days.every(ds=>{
        const entries=hist.filter(h=>h.ts.slice(0,10)===ds);
        if(!entries.length) return false;
        const last=entries[entries.length-1].mood_value;
        return last<=1;
      });
    }
    function maybeShowCrisis(){
      const today=todayStr();
      const dismissed=localStorage.getItem(KEY_CRISIS_DISMISS);
      if(dismissed===today){ crisisBanner.style.display='none'; return; }
      crisisBanner.style.display = verySadStreak3Days() ? 'block' : 'none';
    }
    if (dismissCrisis) dismissCrisis.addEventListener('click', ()=>{
      localStorage.setItem(KEY_CRISIS_DISMISS, todayStr());
      crisisBanner.style.display='none';
    });

    /* ---------- Boot ---------- */
    startBtn.style.display='';
  </script>

  <script>
    // Plausible events (safe if not loaded)
    function track(name, props){ try{ window.plausible && window.plausible(name, { props }); }catch(e){} }
    document.getElementById('goMood')?.addEventListener('click', ()=>track('OpenMood'));
    document.querySelectorAll('.mood')?.forEach(b=> b.addEventListener('click', ()=>track('CheckIn', { mood: b.dataset.val })));
    document.getElementById('goTips')?.addEventListener('click', ()=>track('OpenTips'));
    document.getElementById('goBadges')?.addEventListener('click', ()=>track('OpenBadges'));
  </script>

  <script>
    // Service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js', { scope: './' })
          .catch(err => console.warn('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SpeakOut MindCheck ‚Äî Weekly Monitoring</title>
  <link rel="icon" href="favicon.png"/>
  <link rel="stylesheet" href="mc-theme.css"/>
  <meta name="theme-color" content="#0f766e"/>

  <style>
    main{max-width:900px;margin:20px auto;padding:0 12px;}
    h2{margin-bottom:4px;}
    .muted{color:#52606d;font-size:.9rem;}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin-top:12px;}
    .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;}
    label{display:block;font-size:.85rem;font-weight:600;margin-bottom:2px;}
    input,select{
      width:100%;padding:6px 8px;border-radius:10px;border:1px solid #d1d5db;
      font-size:.85rem;
    }
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .btn-primary{border:none;border-radius:999px;background:#0f766e;color:#fff;
      font-size:.9rem;font-weight:600;padding:8px 16px;cursor:pointer;}
    .btn-ghost{border-radius:999px;border:1px solid #d1d5db;background:#fff;
      font-size:.85rem;padding:6px 14px;cursor:pointer;}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:.82rem;}
    th,td{border:1px solid #e5e7eb;padding:6px 4px;text-align:center;}
    th{background:#f3f4f6;font-weight:700;}
    .status{margin-top:8px;font-size:.85rem;font-weight:600;}
    .ok{color:#166534;}
    .bad{color:#7f1d1d;}
  </style>

  <script defer data-domain="speakoutmentalhealth.github.io" src="https://plausible.io/js/script.js"></script>
  <script>
    (function(){
      try{ window.plausible && window.plausible('MonitoringViewed'); }catch(e){}
    })();
  </script>
</head>
<body>
<header>üß† SpeakOut MindCheck Nigeria</header>

<main>
  <h2>Weekly WHO-Style Monitoring</h2>
  <p class="muted">
    These indicators reflect core WHO community mental-health monitoring domains: coverage, screening,
    detection of red-flag cases, referrals, follow-up, and volunteer effort. Submit one row per week
    per programme or LGA.
  </p>

  <!-- Entry form -->
  <section class="card">
    <h3>Submit weekly summary</h3>
    <div class="grid-2">
      <div>
        <label for="program">Programme / channel</label>
        <input id="program" placeholder="e.g. School clubs ‚Äì Abuja">
      </div>
      <div>
        <label for="lga">LGA / City</label>
        <input id="lga" placeholder="e.g. AMAC, Keffi, Owerri">
      </div>
      <div>
        <label for="week_start">Week starting (Mon)</label>
        <input id="week_start" type="date">
      </div>
      <div>
        <label for="contacts">Help-seeking contacts this week</label>
        <input id="contacts" type="number" min="0" value="0">
      </div>
      <div>
        <label for="screened_pct">% screened (WHO-5 / PHQ-9 / GAD-7 / PSS-10)</label>
        <input id="screened_pct" type="number" min="0" max="100" value="0">
      </div>
      <div>
        <label for="red_flags">Red-flag cases escalated</label>
        <input id="red_flags" type="number" min="0" value="0">
      </div>
      <div>
        <label for="referrals">Referrals issued (clinic / telehelp)</label>
        <input id="referrals" type="number" min="0" value="0">
      </div>
      <div>
        <label for="follow_ups">Follow-ups completed</label>
        <input id="follow_ups" type="number" min="0" value="0">
      </div>
      <div>
        <label for="vol_hours">Volunteer hours logged</label>
        <input id="vol_hours" type="number" min="0" step="0.5" value="0">
      </div>
    </div>

    <div class="toolbar">
      <button id="submitMonitoring" class="btn-primary" type="button">Save weekly data</button>
    </div>
    <div id="monStatus" class="status" style="display:none"></div>
  </section>

  <!-- Front-end only weekly table (reads from localStorage for now) -->
  <section class="card">
    <h3>Local weekly log (for your browser)</h3>
    <p class="muted">
      This table mirrors what is sent to the secure Google Sheet. It is stored only in this browser for
      quick review. Use the export button below if you need a CSV snapshot from this device.
    </p>
    <table id="monTable">
      <thead>
        <tr>
          <th>Week start</th>
          <th>Programme</th>
          <th>LGA</th>
          <th>Contacts</th>
          <th>% screened</th>
          <th>Red flags</th>
          <th>Referrals</th>
          <th>Follow-ups</th>
          <th>Vol hours</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="toolbar">
      <button id="exportCsv" class="btn-ghost" type="button">Export CSV</button>
    </div>
  </section>
</main>

<footer>
  üîí <a href="privacy.html">Privacy</a> ‚Ä¢
  üìÑ <a href="terms.html">Terms</a> ‚Ä¢
  ‚úâÔ∏è <a href="mailto:speaaakout@gmail.com">speaaakout@gmail.com</a>
</footer>

<script>
  const SCRIPT_URL  = 'YOUR_WEBAPP_URL_HERE'; // same Apps Script web app URL
  const AUTH_TOKEN  = 'speakout123';
  const LS_KEY_MON  = 'mc_monitoring_weeks';

  const els = id => document.getElementById(id);
  const monStatus = els('monStatus');

  function setMonStatus(ok,msg){
    monStatus.style.display='block';
    monStatus.className='status ' + (ok?'ok':'bad');
    monStatus.textContent = msg;
  }

  function getLocalMon(){
    try{return JSON.parse(localStorage.getItem(LS_KEY_MON) || '[]');}
    catch(e){return [];}
  }
  function setLocalMon(rows){
    localStorage.setItem(LS_KEY_MON, JSON.stringify(rows));
  }

  function renderTable(){
    const tbody = document.querySelector('#monTable tbody');
    const rows = getLocalMon();
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td>${r.week_start}</td>
        <td>${r.program}</td>
        <td>${r.lga}</td>
        <td>${r.contacts}</td>
        <td>${r.screened_pct}</td>
        <td>${r.red_flags}</td>
        <td>${r.referrals}</td>
        <td>${r.follow_ups}</td>
        <td>${r.vol_hours}</td>
      </tr>
    `).join('');
  }

  async function saveMonitoring(){
    const row = {
      program   : els('program').value.trim(),
      lga       : els('lga').value.trim(),
      week_start: els('week_start').value,
      contacts  : Number(els('contacts').value || 0),
      screened_pct: Number(els('screened_pct').value || 0),
      red_flags : Number(els('red_flags').value || 0),
      referrals : Number(els('referrals').value || 0),
      follow_ups: Number(els('follow_ups').value || 0),
      vol_hours : Number(els('vol_hours').value || 0)
    };

    if(!row.week_start){
      setMonStatus(false,'Please choose a week start date.');
      return;
    }

    setMonStatus(false,'Saving to MindCheck register‚Ä¶');

    try{
      const payload = Object.assign({}, row, {
        auth: AUTH_TOKEN,
        type:'monitoring_week'
      });
      const res = await fetch(SCRIPT_URL + '?auth=' + encodeURIComponent(AUTH_TOKEN), {
        method:'POST',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>({}));
      if(data && data.ok){
        setMonStatus(true,'‚úÖ Saved. Weekly indicators recorded in the register.');
        const rows = getLocalMon();
        rows.push(row);
        setLocalMon(rows);
        renderTable();
        try{ window.plausible && window.plausible('MonitoringSaved'); }catch(e){}
      } else {
        setMonStatus(false,'‚ùå Could not save. Please try again.');
      }
    }catch(e){
      console.error(e);
      setMonStatus(false,'‚ùå Network error while saving.');
    }
  }

  function exportCsv(){
    const rows = getLocalMon();
    if(!rows.length){
      alert('No local rows to export yet.');
      return;
    }
    const header = [
      'week_start','program','lga','contacts','screened_pct',
      'red_flags','referrals','follow_ups','vol_hours'
    ];
    const lines = [header.join(',')].concat(
      rows.map(r => header.map(h => `"${String(r[h] ?? '').replace(/"/g,'""')}"`).join(','))
    );
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url;
    a.download = 'mindcheck-weekly-monitoring.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    try{ window.plausible && window.plausible('MonitoringExport'); }catch(e){}
  }

  els('submitMonitoring').addEventListener('click', saveMonitoring);
  els('exportCsv').addEventListener('click', exportCsv);

  renderTable();
</script>
</body>
</html>
